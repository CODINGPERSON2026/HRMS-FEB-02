<!-- Parade State Modal -->
<div class="modal fade" id="paradestate" tabindex="-1" aria-labelledby="paradestateLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="paradestateLabel">Daily Parade State - {{ current_date }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Parade State Form -->
        <form id="paradeStateForm" method="POST" action="/api/parade-state/submit">
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="parade_date" class="form-label">Date</label>
              <input type="date" class="form-control" id="parade_date" name="parade_date" required>
            </div>
            <div class="col-md-4">
              <label for="unit" class="form-label">Unit</label>
              <input type="text" class="form-control" id="unit" name="unit" required>
            </div>
            <div class="col-md-4">
              <label for="auth" class="form-label">AUTH (Authorized Strength)</label>
              <input type="number" class="form-control" id="auth" name="auth" required>
            </div>
          </div>

          <!-- Today's Parade Section -->
          <h6 class="mb-3 text-primary">TODAY'S PARADE</h6>
          <div class="table-responsive mb-4">
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Category</th>
                  <th>Officers</th>
                  <th>JCOs</th>
                  <th>ORs</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Present/STR</td>
                  <td><input type="number" class="form-control form-control-sm" name="present_officers" id="present_officers"></td>
                  <td><input type="number" class="form-control form-control-sm" name="present_jcos" id="present_jcos"></td>
                  <td><input type="number" class="form-control form-control-sm" name="present_ors" id="present_ors"></td>
                  <td><input type="number" class="form-control form-control-sm" name="present_total" id="present_total" readonly></td>
                </tr>
                <tr>
                  <td>On Leave (CRE)</td>
                  <td><input type="number" class="form-control form-control-sm" name="leave_officers" id="leave_officers"></td>
                  <td><input type="number" class="form-control form-control-sm" name="leave_jcos" id="leave_jcos"></td>
                  <td><input type="number" class="form-control form-control-sm" name="leave_ors" id="leave_ors"></td>
                  <td><input type="number" class="form-control form-control-sm" name="leave_total" id="leave_total" readonly></td>
                </tr>
                <tr>
                  <td>Detachment (DET)</td>
                  <td><input type="number" class="form-control form-control-sm" name="det_officers" id="det_officers"></td>
                  <td><input type="number" class="form-control form-control-sm" name="det_jcos" id="det_jcos"></td>
                  <td><input type="number" class="form-control form-control-sm" name="det_ors" id="det_ors"></td>
                  <td><input type="number" class="form-control form-control-sm" name="det_total" id="det_total" readonly></td>
                </tr>
                <tr>
                  <td>Sick (MH)</td>
                  <td><input type="number" class="form-control form-control-sm" name="sick_officers" id="sick_officers"></td>
                  <td><input type="number" class="form-control form-control-sm" name="sick_jcos" id="sick_jcos"></td>
                  <td><input type="number" class="form-control form-control-sm" name="sick_ors" id="sick_ors"></td>
                  <td><input type="number" class="form-control form-control-sm" name="sick_total" id="sick_total" readonly></td>
                </tr>
                <tr>
                  <td>Attached In (ATT IN)</td>
                  <td><input type="number" class="form-control form-control-sm" name="att_in_officers" id="att_in_officers"></td>
                  <td><input type="number" class="form-control form-control-sm" name="att_in_jcos" id="att_in_jcos"></td>
                  <td><input type="number" class="form-control form-control-sm" name="att_in_ors" id="att_in_ors"></td>
                  <td><input type="number" class="form-control form-control-sm" name="att_in_total" id="att_in_total" readonly></td>
                </tr>
                <tr>
                  <td>Attached Out (ATT OUT)</td>
                  <td><input type="number" class="form-control form-control-sm" name="att_out_officers" id="att_out_officers"></td>
                  <td><input type="number" class="form-control form-control-sm" name="att_out_jcos" id="att_out_jcos"></td>
                  <td><input type="number" class="form-control form-control-sm" name="att_out_ors" id="att_out_ors"></td>
                  <td><input type="number" class="form-control form-control-sm" name="att_out_total" id="att_out_total" readonly></td>
                </tr>
                <tr class="table-secondary">
                  <td><strong>Grand Total</strong></td>
                  <td><input type="number" class="form-control form-control-sm" name="grand_officers" id="grand_officers" readonly></td>
                  <td><input type="number" class="form-control form-control-sm" name="grand_jcos" id="grand_jcos" readonly></td>
                  <td><input type="number" class="form-control form-control-sm" name="grand_ors" id="grand_ors" readonly></td>
                  <td><input type="number" class="form-control form-control-sm" name="grand_total" id="grand_total" readonly></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Posting Section -->
          <h6 class="mb-3 text-primary">POSTING</h6>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Dues In</label>
              <textarea class="form-control" name="dues_in" rows="2"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Dues Out</label>
              <textarea class="form-control" name="dues_out" rows="2"></textarea>
            </div>
          </div>

          <!-- Percentage Calculations -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">COY Wise Live %</label>
              <input type="number" step="0.01" class="form-control" name="coy_wise_live_pct" id="coy_wise_live_pct" readonly>
            </div>
            <div class="col-md-3">
              <label class="form-label">HQ COY</label>
              <input type="number" step="0.01" class="form-control" name="hq_coy" id="hq_coy">
            </div>
            <div class="col-md-3">
              <label class="form-label">1 COY</label>
              <input type="number" step="0.01" class="form-control" name="coy_1" id="coy_1">
            </div>
            <div class="col-md-3">
              <label class="form-label">2 COY</label>
              <input type="number" step="0.01" class="form-control" name="coy_2" id="coy_2">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">3 COY</label>
              <input type="number" step="0.01" class="form-control" name="coy_3" id="coy_3">
            </div>
            <div class="col-md-4">
              <label class="form-label">Total Live %</label>
              <input type="number" step="0.01" class="form-control" name="total_live_pct" id="total_live_pct" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">Jcos Live %</label>
              <input type="number" step="0.01" class="form-control" name="jcos_live_pct" id="jcos_live_pct" readonly>
            </div>
          </div>

          <!-- Remarks -->
          <div class="mb-3">
            <label class="form-label">Remarks</label>
            <textarea class="form-control" name="remarks" rows="3"></textarea>
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Submit Parade State</button>
          </div>
        </form>

        <hr class="my-4">

        <!-- Historical Data Section -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Previous Parade States</h5>
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="filterParadeStates('week')">Last Week</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="filterParadeStates('month')">Last Month</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="filterParadeStates('year')">Last Year</button>
            <button type="button" class="btn btn-sm btn-outline-secondary active" onclick="filterParadeStates('all')">All</button>
          </div>
        </div>

        <!-- Historical Records Table -->
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="paradeHistoryTable">
            <thead class="table-dark">
              <tr>
                <th>Date</th>
                <th>Unit</th>
                <th>Present/STR</th>
                <th>On Leave</th>
                <th>Total</th>
                <th>Live %</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="paradeHistoryBody">
              <!-- Data will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="paradeDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Parade State Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="paradeDetailsContent">
        <!-- Details will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
// Auto-calculate totals
document.addEventListener('DOMContentLoaded', function() {
  // Set today's date
  document.getElementById('parade_date').valueAsDate = new Date();
  
  // Calculate row totals
  const categories = ['present', 'leave', 'det', 'sick', 'att_in', 'att_out'];
  
  categories.forEach(cat => {
    ['officers', 'jcos', 'ors'].forEach(rank => {
      document.getElementById(`${cat}_${rank}`).addEventListener('input', function() {
        calculateRowTotal(cat);
        calculateColumnTotals();
        calculatePercentages();
      });
    });
  });
  
  function calculateRowTotal(category) {
    const officers = parseInt(document.getElementById(`${category}_officers`).value) || 0;
    const jcos = parseInt(document.getElementById(`${category}_jcos`).value) || 0;
    const ors = parseInt(document.getElementById(`${category}_ors`).value) || 0;
    document.getElementById(`${category}_total`).value = officers + jcos + ors;
  }
  
  function calculateColumnTotals() {
    const ranks = ['officers', 'jcos', 'ors', 'total'];
    
    ranks.forEach(rank => {
      let sum = 0;
      categories.forEach(cat => {
        sum += parseInt(document.getElementById(`${cat}_${rank}`).value) || 0;
      });
      document.getElementById(`grand_${rank}`).value = sum;
    });
  }
  
  function calculatePercentages() {
    const auth = parseInt(document.getElementById('auth').value) || 1;
    const presentTotal = parseInt(document.getElementById('present_total').value) || 0;
    const totalLivePct = ((presentTotal / auth) * 100).toFixed(2);
    document.getElementById('total_live_pct').value = totalLivePct;
  }
  
  // Load historical data
  loadParadeHistory();
});

// Submit form
document.getElementById('paradeStateForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  fetch('/api/parade-state/submit', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    alert('Parade State submitted successfully!');
    loadParadeHistory();
    this.reset();
  })
  .catch(error => {
    alert('Error submitting parade state: ' + error);
  });
});

// Load historical parade states
function loadParadeHistory(filter = 'all') {
  fetch(`/api/parade-state/history?filter=${filter}`)
    .then(response => response.json())
    .then(data => {
      const tbody = document.getElementById('paradeHistoryBody');
      tbody.innerHTML = '';
      
      data.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${record.parade_date}</td>
          <td>${record.unit}</td>
          <td>${record.present_total}</td>
          <td>${record.leave_total}</td>
          <td>${record.grand_total}</td>
          <td>${record.total_live_pct}%</td>
          <td>
            <button class="btn btn-sm btn-info" onclick="viewParadeDetails(${record.id})">
              View Details
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    });
}

// Filter parade states
function filterParadeStates(period) {
  document.querySelectorAll('.btn-group button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  loadParadeHistory(period);
}

// View parade details
function viewParadeDetails(id) {
  fetch(`/api/parade-state/details/${id}`)
    .then(response => response.json())
    .then(data => {
      const content = document.getElementById('paradeDetailsContent');
      content.innerHTML = `
        <div class="row mb-3">
          <div class="col-md-4"><strong>Date:</strong> ${data.parade_date}</div>
          <div class="col-md-4"><strong>Unit:</strong> ${data.unit}</div>
          <div class="col-md-4"><strong>AUTH:</strong> ${data.auth}</div>
        </div>
        
        <h6 class="text-primary">Strength Details</h6>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Category</th>
              <th>Officers</th>
              <th>JCOs</th>
              <th>ORs</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Present/STR</td>
              <td>${data.present_officers}</td>
              <td>${data.present_jcos}</td>
              <td>${data.present_ors}</td>
              <td>${data.present_total}</td>
            </tr>
            <tr>
              <td>On Leave</td>
              <td>${data.leave_officers}</td>
              <td>${data.leave_jcos}</td>
              <td>${data.leave_ors}</td>
              <td>${data.leave_total}</td>
            </tr>
            <tr>
              <td>Detachment</td>
              <td>${data.det_officers}</td>
              <td>${data.det_jcos}</td>
              <td>${data.det_ors}</td>
              <td>${data.det_total}</td>
            </tr>
            <tr>
              <td>Sick</td>
              <td>${data.sick_officers}</td>
              <td>${data.sick_jcos}</td>
              <td>${data.sick_ors}</td>
              <td>${data.sick_total}</td>
            </tr>
          </tbody>
        </table>
        
        <div class="row mt-3">
          <div class="col-md-6">
            <strong>Dues In:</strong><br>${data.dues_in || 'N/A'}
          </div>
          <div class="col-md-6">
            <strong>Dues Out:</strong><br>${data.dues_out || 'N/A'}
          </div>
        </div>
        
        <div class="mt-3">
          <strong>Remarks:</strong><br>${data.remarks || 'N/A'}
        </div>
      `;
      
      const detailsModal = new bootstrap.Modal(document.getElementById('paradeDetailsModal'));
      detailsModal.show();
    });
}
</script>

<style>
.table-responsive {
  max-height: 400px;
  overflow-y: auto;
}

.form-control-sm {
  font-size: 0.875rem;
}

.btn-group {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>