<style>
  .parade-table {
    font-size: 0.8rem;
    white-space: nowrap;
  }

  .parade-table th {
    background: #2c3e50;
    color: white;
    padding: 8px 4px;
    text-align: center;
    font-size: 0.75rem;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .parade-table td {
    padding: 4px;
    text-align: center;
  }

  .parade-table input.form-control {
    width: 60px;
    padding: 4px;
    font-size: 0.75rem;
    text-align: center;
  }

  .category-label {
    font-weight: 600;
    background: #ecf0f1;
    text-align: left !important;
    padding-left: 10px !important;
    min-width: 150px;
  }

  .total-row {
    background: #d5e8f7 !important;
    font-weight: bold;
  }

  .calculated-cell {
    background: #fff3cd !important;
    font-weight: 600;
  }

  .read-only-cell {
    background: #e9ecef;
    cursor: not-allowed;
  }

  #paradeTableContainer {
    max-height: 65vh;
    overflow: auto;
  }

  .mode-badge {
    font-size: 0.9rem;
    padding: 6px 12px;
  }
</style>

<div class="modal fade" id="paradeDataModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen" style="margin: 10px; max-width: calc(100vw - 20px);">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title text-white">
          <i class="fas fa-clipboard-list me-2"></i>
          Parade State Data Management
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body p-3">
        <!-- Control Panel -->
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <!-- Date Selection -->
              <div class="col-md-3">
                <label class="form-label fw-bold mb-1">
                  <i class="fas fa-calendar text-primary me-1"></i> Select Date
                </label>
                <input type="date" class="form-control" id="paradeDate" />
              </div>

              <!-- Company Selection -->
              <div class="col-md-3">
                <label class="form-label fw-bold mb-1">
                  <i class="fas fa-building text-success me-1"></i> Select Company
                </label>
                <select class="form-select" id="paradeCompany">
                  <option value="">-- Select Company --</option>
                  <option value="1 company">1 Company</option>
                  <option value="2 company">2 Company</option>
                  <option value="3 company">3 Company</option>
                  <option value="4 company">4 Company</option>
                  <option value="All">All Companies</option>
                </select>
              </div>

              <!-- Action Buttons -->
              <div class="col-md-6">
                <button class="btn btn-primary me-2" id="btnEnterData">
                  <i class="fas fa-edit me-1"></i> Enter/Edit
                </button>
                <button class="btn btn-info text-white me-2" id="btnViewData">
                  <i class="fas fa-eye me-1"></i> View
                </button>
                <button class="btn btn-success" id="btnExportCSV" disabled>
                  <i class="fas fa-download me-1"></i> Export CSV
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Status Bar -->
        <div class="alert alert-info d-none mb-3" id="statusBar">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <span class="badge mode-badge bg-primary me-2" id="modeDisplay">-</span>
              <strong>Company:</strong> <span id="companyDisplay">-</span> | 
              <strong>Date:</strong> <span id="dateDisplay">-</span>
            </div>
            <button class="btn btn-sm btn-light" id="btnRefresh">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>

        <!-- Loading Spinner -->
        <div class="text-center py-5 d-none" id="loadingSpinner">
          <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading parade data...</p>
        </div>

        <!-- Parade Table -->
        <div id="paradeTableContainer" class="d-none">
          <div class="table-responsive">
            <table class="table table-bordered parade-table" id="paradeTable">
              <thead>
                <tr>
                  <th rowspan="2" style="min-width: 150px;">Category</th>
                  <th>AUTH</th>
                  <th>H/S</th>
                  <th>POSTED/STR</th>
                  <th>LVE</th>
                  <th>COURSE</th>
                  <th>DET</th>
                  <th>MH</th>
                  <th>SICK/LVE</th>
                  <th>EX</th>
                  <th>TD</th>
                  <th>ATT</th>
                  <th>AWL/OSL/JC</th>
                  <th class="bg-warning">T/OUT</th>
                  <th class="bg-info text-white">PRES/DET</th>
                  <th class="bg-success text-white">PRES/UNIT</th>
                  <th>DUES IN</th>
                  <th>DUES OUT</th>
                </tr>
              </thead>
              <tbody id="paradeTableBody">
                <!-- Rows will be generated dynamically -->
              </tbody>
            </table>
          </div>

          <!-- Save Button (Edit Mode Only) -->
          <div class="text-center mt-3 d-none" id="saveContainer">
            <button class="btn btn-success btn-lg px-5" id="btnSave">
              <i class="fas fa-save me-2"></i> Save Parade Data
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
// Wait for DOM to be fully loaded before executing JavaScript
window.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded');
    
    // Check if we're in a page that has the parade modal
    const paradeModal = document.getElementById('paradeDataModal');
    if (!paradeModal) {
        console.log('Parade modal not found on this page');
        return;
    }

    // Only initialize parade manager when modal is shown
    let paradeDataManagerInitialized = false;
    
    paradeModal.addEventListener('shown.bs.modal', function() {
        if (!paradeDataManagerInitialized) {
            initializeParadeDataManager();
            paradeDataManagerInitialized = true;
        }
    });

    // Dashboard loading function
    loadDashboardIfNeeded();
});

function initializeParadeDataManager() {
    console.log('Initializing Parade Data Manager');
    
    const ParadeDataManager = {
        currentMode: null,
        currentDate: null,
        currentCompany: null,
        paradeData: {},

        categories: [
            { key: 'offr', label: 'OFFR', editable: true },
            { key: 'jco', label: 'JCO', editable: true },
            { key: 'jcoEre', label: 'JCO (ERE)', editable: true },
            { key: 'or', label: 'OR', editable: true },
            { key: 'orEre', label: 'OR (ERE)', editable: true },
            { key: 'firstTotal', label: 'TOTAL (I)', editable: false },
            { key: 'oaOr', label: 'OA/OR', editable: true },
            { key: 'attSummary', label: 'SUPERNUMARARY', editable: true },
            { key: 'attOffr', label: 'ATT (OFFR)', editable: true },
            { key: 'attJco', label: 'ATT (JCO)', editable: true },
            { key: 'attOr', label: 'ATT (OR)', editable: true },
            { key: 'secondTotal', label: 'TOTAL (II)', editable: false },
            { key: 'grandTotal', label: 'GRAND TOTAL', editable: false }
        ],

        init() {
            console.log('Setting up event listeners');
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('paradeDate');
            if (dateInput) {
                dateInput.value = today;
                dateInput.max = today;
            }

            // Setup event listeners
            this.setupEventListeners();
        },

        setupEventListeners() {
            // Button event listeners
            const btnEnterData = document.getElementById('btnEnterData');
            const btnViewData = document.getElementById('btnViewData');
            const btnExportCSV = document.getElementById('btnExportCSV');
            const btnSave = document.getElementById('btnSave');
            const btnRefresh = document.getElementById('btnRefresh');
            const paradeTableBody = document.getElementById('paradeTableBody');

            if (btnEnterData) {
                btnEnterData.addEventListener('click', () => this.handleEnterData());
                console.log('Enter Data button listener added');
            } else {
                console.error('btnEnterData element not found');
            }

            if (btnViewData) {
                btnViewData.addEventListener('click', () => this.handleViewData());
                console.log('View Data button listener added');
            }

            if (btnExportCSV) {
                btnExportCSV.addEventListener('click', () => this.exportCSV());
            }

            if (btnSave) {
                btnSave.addEventListener('click', () => this.saveData());
            }

            if (btnRefresh) {
                btnRefresh.addEventListener('click', () => this.refreshData());
            }

            // Auto-calculate on input
            if (paradeTableBody) {
                paradeTableBody.addEventListener('input', (e) => {
                    if (e.target.tagName === 'INPUT') {
                        this.handleInputChange(e.target);
                    }
                });
            }
        },

        async handleEnterData() {
            console.log('Enter Data clicked');
            
            const date = document.getElementById('paradeDate')?.value;
            const company = document.getElementById('paradeCompany')?.value;

            console.log('Checking authentication...');
    try {
        const authCheck = await fetch('/debug/user-info');
        const authData = await authCheck.json();
        console.log('Current user:', authData);
    } catch (err) {
        console.error('Auth check failed:', err);
    }

    if (!date || !company) {
        this.showAlert('Please select both date and company', 'warning');
        return;
    }

            if (!date || !company) {
                this.showAlert('Please select both date and company', 'warning');
                return;
            }

            if (company === 'All') {
                this.showAlert('Please select a specific company for data entry', 'warning');
                return;
            }

            // Check if date is today
            const today = new Date().toISOString().split('T')[0];
            if (date !== today) {
                this.showAlert('You can only enter/edit data for today', 'error');
                return;
            }

            this.currentMode = 'edit';
            this.currentDate = date;
            this.currentCompany = company;
            await this.loadData();
        },

        async handleViewData() {
            console.log('View Data clicked');
            
            const date = document.getElementById('paradeDate')?.value;
            const company = document.getElementById('paradeCompany')?.value;

            if (!date || !company) {
                this.showAlert('Please select both date and company', 'warning');
                return;
            }

            this.currentMode = 'view';
            this.currentDate = date;
            this.currentCompany = company;
            await this.loadData();
        },

        async loadData() {
            console.log(`Loading data for ${this.currentCompany} on ${this.currentDate}`);
            
            this.showLoading(true);
            const paradeTableContainer = document.getElementById('paradeTableContainer');
            if (paradeTableContainer) {
                paradeTableContainer.classList.add('d-none');
            }

            try {
                const url = this.currentCompany === 'All'
                    ? `/api/parade-data/view-all/${this.currentDate}`
                    : `/api/parade-data/get/${this.currentDate}/${encodeURIComponent(this.currentCompany)}`;

                console.log(`Fetching from URL: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('API endpoint not found. Please check if you are logged in as O SEC NCO.');
                    }
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error('Server returned non-JSON response. Please check if you are logged in.');
                }
                
                const result = await response.json();
                console.log('API Response:', result);
                
                if (result.success) {
                    if (result.is_empty) {
                        if (this.currentMode === 'edit') {
                            this.paradeData = this.getEmptyData();
                            this.renderTable();
                            this.updateStatusBar();
                            this.showAlert('No existing data. You can enter new data below.', 'info');
                        } else {
                            this.showAlert('No data found for this date and company', 'info');
                        }
                    } else {
                        this.paradeData = result.data.data || {};
                        this.renderTable();
                        this.updateStatusBar();
                    }
                    const exportBtn = document.getElementById('btnExportCSV');
                    if (exportBtn) {
                        exportBtn.disabled = result.is_empty || false;
                    }
                } else {
                    this.showAlert(result.error || 'Failed to load data', 'error');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                this.showAlert('Error loading data: ' + error.message, 'error');
            } finally {
                this.showLoading(false);
            }
        },

        renderTable() {
            const tbody = document.getElementById('paradeTableBody');
            if (!tbody) {
                console.error('Table body not found');
                return;
            }
            tbody.innerHTML = '';

            let actualData = this.paradeData;
            if (this.paradeData.data) {
                actualData = this.paradeData.data;
            }

            this.categories.forEach((category, idx) => {
                const row = document.createElement('tr');
                const isTotal = !category.editable;
                
                if (isTotal) {
                    row.classList.add('total-row');
                }

                // Category Label
                const labelCell = document.createElement('td');
                labelCell.className = 'category-label';
                labelCell.textContent = category.label;
                row.appendChild(labelCell);

                // Data Cells (17 columns)
                const data = actualData[category.key] || Array(17).fill(0);
                
                for (let i = 0; i < 17; i++) {
                    const cell = document.createElement('td');
                    const isCalculated = (i === 12 || i === 13 || i === 14);

                    if (this.currentMode === 'edit' && category.editable && !isCalculated) {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.className = 'form-control';
                        input.value = data[i] || 0;
                        input.min = 0;
                        input.dataset.category = category.key;
                        input.dataset.index = i;
                        cell.appendChild(input);
                    } else {
                        cell.textContent = data[i] || 0;
                        if (isCalculated) {
                            cell.classList.add('calculated-cell');
                        } else if (this.currentMode === 'view' || !category.editable) {
                            cell.classList.add('read-only-cell');
                        }
                    }

                    row.appendChild(cell);
                }

                tbody.appendChild(row);
            });

            this.paradeData = actualData;

            if (this.currentMode === 'edit') {
                this.calculateAllTotals();
            }

            const saveContainer = document.getElementById('saveContainer');
            const paradeTableContainer = document.getElementById('paradeTableContainer');
            if (saveContainer) {
                saveContainer.classList.toggle('d-none', this.currentMode !== 'edit');
            }
            if (paradeTableContainer) {
                paradeTableContainer.classList.remove('d-none');
            }
            
            console.log('Table rendered successfully');
        },

        handleInputChange(input) {
            const category = input.dataset.category;
            const index = parseInt(input.dataset.index);
            const value = parseInt(input.value) || 0;

            if (!this.paradeData[category]) {
                this.paradeData[category] = Array(17).fill(0);
            }
            this.paradeData[category][index] = value;

            this.calculateRow(category);
            this.calculateAllTotals();
        },

        calculateRow(categoryKey) {
            const data = this.paradeData[categoryKey];
            if (!data || data.length < 17) return;

            const tOut = data[3] + data[4] + data[6] + data[7] + data[8] + data[9] + data[10] + data[11];
            data[12] = Math.max(0, tOut);
            data[13] = data[5];
            data[14] = Math.max(0, data[2] - data[12]);

            this.updateRowDisplay(categoryKey);
        },

        calculateAllTotals() {
            const firstTotalData = Array(17).fill(0);
            ['offr', 'jco', 'jcoEre', 'or', 'orEre'].forEach(cat => {
                const data = this.paradeData[cat] || Array(17).fill(0);
                for (let i = 0; i < 17; i++) {
                    firstTotalData[i] += data[i] || 0;
                }
            });
            this.paradeData.firstTotal = firstTotalData;

            const secondTotalData = Array(17).fill(0);
            ['oaOr', 'attSummary', 'attOffr', 'attJco', 'attOr'].forEach(cat => {
                const data = this.paradeData[cat] || Array(17).fill(0);
                for (let i = 0; i < 17; i++) {
                    secondTotalData[i] += data[i] || 0;
                }
            });
            this.paradeData.secondTotal = secondTotalData;

            const grandTotalData = Array(17).fill(0);
            for (let i = 0; i < 17; i++) {
                grandTotalData[i] = firstTotalData[i] + secondTotalData[i];
            }
            this.paradeData.grandTotal = grandTotalData;

            this.updateRowDisplay('firstTotal');
            this.updateRowDisplay('secondTotal');
            this.updateRowDisplay('grandTotal');
        },

        updateRowDisplay(categoryKey) {
            const data = this.paradeData[categoryKey];
            if (!data) return;

            const rows = document.getElementById('paradeTableBody')?.querySelectorAll('tr');
            if (!rows) return;
            
            const categoryIndex = this.categories.findIndex(c => c.key === categoryKey);
            if (categoryIndex === -1) return;
            
            const row = rows[categoryIndex];
            if (!row) return;
            
            const cells = row.querySelectorAll('td');
            
            for (let i = 0; i < 17; i++) {
                const cell = cells[i + 1];
                if (cell) {
                    const input = cell.querySelector('input');
                    if (input) {
                        input.value = data[i] || 0;
                    } else {
                        cell.textContent = data[i] || 0;
                    }
                }
            }
        },

        async saveData() {
            if (this.currentMode !== 'edit') {
                this.showAlert('Cannot save in view mode', 'warning');
                return;
            }

            if (!this.paradeData || Object.keys(this.paradeData).length === 0) {
                this.showAlert('No data to save', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/parade-data/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: this.currentDate,
                        company: this.currentCompany,
                        data: this.paradeData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.showAlert('Data saved successfully!', 'success');
                } else {
                    this.showAlert(result.error || 'Failed to save data', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                this.showAlert('Error saving data: ' + error.message, 'error');
            }
        },

        async exportCSV() {
            if (!this.currentDate || !this.currentCompany) {
                this.showAlert('Please load data first', 'warning');
                return;
            }

            try {
                const url = `/api/parade-data/export-csv/${this.currentDate}/${encodeURIComponent(this.currentCompany)}`;
                window.open(url, '_blank');
            } catch (error) {
                console.error('Export error:', error);
                this.showAlert('Error exporting CSV', 'error');
            }
        },

        refreshData() {
            if (this.currentMode && this.currentDate && this.currentCompany) {
                this.loadData();
            }
        },

        getEmptyData() {
            const data = {};
            this.categories.forEach(cat => {
                data[cat.key] = Array(17).fill(0);
            });
            return data;
        },

        updateStatusBar() {
            const statusBar = document.getElementById('statusBar');
            const modeDisplay = document.getElementById('modeDisplay');
            const companyDisplay = document.getElementById('companyDisplay');
            const dateDisplay = document.getElementById('dateDisplay');

            if (statusBar) statusBar.classList.remove('d-none');
            if (modeDisplay) {
                modeDisplay.textContent = this.currentMode === 'edit' ? 'EDIT MODE' : 'VIEW MODE';
                modeDisplay.className = `badge mode-badge ${this.currentMode === 'edit' ? 'bg-success' : 'bg-info'}`;
            }
            if (companyDisplay) companyDisplay.textContent = this.currentCompany;
            if (dateDisplay) dateDisplay.textContent = this.currentDate;
        },

        showLoading(show) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.classList.toggle('d-none', !show);
            }
        },

        showAlert(message, type) {
            const alertTypes = {
                success: 'alert-success',
                error: 'alert-danger',
                warning: 'alert-warning',
                info: 'alert-info'
            };

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertTypes[type] || 'alert-info'} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const modalBody = document.querySelector('#paradeDataModal .modal-body');
            if (modalBody) {
                modalBody.insertBefore(alertDiv, modalBody.firstChild);
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }
    };

    // Initialize the manager
    ParadeDataManager.init();
}

function loadDashboardIfNeeded() {
    // Check if dashboard elements exist
    const hasDashboardElements = document.getElementById('manpowerTotal') || 
                                 document.getElementById('detachmentTotal') || 
                                 document.getElementById('interviewPendingCount');
    
    if (hasDashboardElements) {
        console.log('Loading dashboard data...');
        loadDashboardDataSingleAPI();
    }
}

async function loadDashboardDataSingleAPI() {
    try {
        console.log("Loading dashboard data...");
        
        const response = await fetch('/api/dashboard_summary');
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.log("Non-JSON response received:", text.substring(0, 200));
            throw new Error('Server returned non-JSON response. Please check if you are logged in.');
        }
        
        const data = await response.json();
        console.log("Dashboard data loaded:", data);
        
        if (data.status === 'success') {
            // Update dashboard elements if they exist
            updateDashboardElement('manpowerTotal', data.manpower);
            updateDashboardElement('detachmentTotal', data.detachments);
            updateDashboardElement('interviewPendingCount', data.interview?.pending_count);
            updateDashboardElement('projectsTotal', data.projects);
            updateDashboardElement('boardsTotal', data.boards_count);
            updateDashboardElement('sensitiveTotal', data.sensitive_count);
            updateDashboardElement('attachmentTotal', data.attachment_count);
        } else {
            console.error('Error from server:', data.message);
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

function updateDashboardElement(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerText = value || 0;
    } else {
        console.log(`Element ${elementId} not found`);
    }
}

function updateDateDisplay() {
    const dateDisplay = document.getElementById('currentDateDisplay');
    if (dateDisplay) {
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateDisplay.textContent = today.toLocaleDateString('en-US', options);
    }
}
// Check user info on page load
setTimeout(() => {
    checkUserInfo();
}, 1000);

async function checkUserInfo() {
    try {
        const response = await fetch('/debug/user-info');
        if (response.ok) {
            const data = await response.json();
            console.log('User Info:', data);
        }
    } catch (error) {
        console.log('Cannot access debug endpoint:', error);
    }
}
</script>