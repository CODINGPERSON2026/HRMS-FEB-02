<div class="modal fade" id="agniveersModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Agniveer Assistant Test</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- Batch Filter Only -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text">
                <i class="bi bi-filter"></i> Batch
              </span>
              <select id="batchFilter" class="form-select">
                <option value="all">All Batches</option>
                <option>Batch 1</option>
                <option>Batch 2</option>
                <option>Batch 3</option>
                <option>Batch 4</option>
                <option>Batch 5</option>
                <option>Batch 6</option>
              </select>
              <button id="resetFilter" class="btn btn-outline-secondary" type="button">
                Reset
              </button>
            </div>
          </div>
        </div>

        <!-- TABLE -->
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th>Batch</th>
                
                <th>Test 1</th>
                <th>Test 2</th>
                <th>Test 3</th>
                <th>Test 4</th>
              </tr>
            </thead>
            <tbody id="agniveerTableBody">
              <tr>
                <td colspan="6" class="text-center">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  let allAgniveersData = [];
  let filteredData = [];

  document.getElementById('agniveersModal')
    .addEventListener('shown.bs.modal', function () {
      loadAgniveersData();
    });

  function loadAgniveersData() {
    const tbody = document.getElementById("agniveerTableBody");
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center">
          <div class="spinner-border spinner-border-sm me-2"></div>
          Loading data...
        </td>
      </tr>`;

    fetch('/get_all_agniveers')
      .then(res => res.json())
      .then(data => {
        allAgniveersData = data;
        applyFilters();
      })
      .catch(err => {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Error loading data
            </td>
          </tr>`;
      });
  }

  function applyFilters() {
    const batchFilter = document.getElementById('batchFilter').value;

    if (batchFilter === 'all') {
      filteredData = [...allAgniveersData];
    } else {
      filteredData = allAgniveersData.filter(agniveer => 
        agniveer.batch === batchFilter
      );
    }

    renderTable(filteredData);
  }

  function renderTable(data) {
    const tbody = document.getElementById("agniveerTableBody");
    
    if (!data.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-muted py-4">
            <i class="bi bi-inbox me-2"></i>
            No records found for selected batch
          </td>
        </tr>`;
      return;
    }

    tbody.innerHTML = '';

    data.forEach(p => {
      // Find upcoming tests (status = 0)
      const upcomingTests = [];
      const upcomingTestInfo = [];
      
      if (p.test1_status === 0) {
        upcomingTests.push('Test 1');
        if (p.asst_test1) {
          upcomingTestInfo.push(`Test 1: ${formatDate(p.asst_test1)}`);
        }
      }
      if (p.test2_status === 0) {
        upcomingTests.push('Test 2');
        if (p.asst_test2) {
          upcomingTestInfo.push(`Test 2: ${formatDate(p.asst_test2)}`);
        }
      }
      if (p.test3_status === 0) {
        upcomingTests.push('Test 3');
        if (p.asst_test3) {
          upcomingTestInfo.push(`Test 3: ${formatDate(p.asst_test3)}`);
        }
      }
      if (p.test4_status === 0) {
        upcomingTests.push('Test 4');
        if (p.asst_test4) {
          upcomingTestInfo.push(`Test 4: ${formatDate(p.asst_test4)}`);
        }
      }

      // Format date function
      function formatDate(dateStr) {
        if (!dateStr) return 'Not set';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-GB'); // DD/MM/YYYY
      }

      // Determine date cell content
      function getDateCell(testDate, status, testNumber) {
        if (!testDate) {
          return `<div class="text-muted small">Not scheduled</div>`;
        }
        
        const dateFormatted = formatDate(testDate);
        const badgeClass = status === 1 ? 'bg-success' : 'bg-warning text-dark';
        const badgeText = status === 1 ? 'âœ“' : 'Pending';
        
        return `
          <div class="d-flex align-items-center">
            <span class="badge ${badgeClass} me-2" style="font-size: 0.7rem">${badgeText}</span>
            <div>
              <div class="fw-medium">${dateFormatted}</div>
            </div>
          </div>
        `;
      }

      tbody.innerHTML += `
        <tr>
          <td>
            <span class="badge bg-primary fs-6">${p.batch || 'N/A'}</span>
          </td>
        
          <td>${getDateCell(p.asst_test1, p.test1_status, 1)}</td>
          <td>${getDateCell(p.asst_test2, p.test2_status, 2)}</td>
          <td>${getDateCell(p.asst_test3, p.test3_status, 3)}</td>
          <td>${getDateCell(p.asst_test4, p.test4_status, 4)}</td>
        </tr>`;
    });
  }

  // Event Listeners
  document.getElementById('batchFilter').addEventListener('change', function() {
    applyFilters();
  });

  document.getElementById('resetFilter').addEventListener('click', function() {
    document.getElementById('batchFilter').value = 'all';
    applyFilters();
  });

 
</script>