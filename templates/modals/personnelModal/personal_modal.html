<!-- Modal -->
<div class="modal fade" id="personnelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Assign Personnel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex mb-3">
          <input type="text" id="searchInput" class="form-control me-2" placeholder="Search by name or trade">
          <button class="btn btn-success" id="searchBtn">Search</button>
        </div>
        <div class="mb-3">
          <label class="form-label">Select Action</label>
          <select id="actionType" class="form-select">
            <option value="">-- Select Action --</option>
            <option value="det">Detachment</option>
            <option value="posting">Posting</option>
          </select>
        </div>
        
        <div class="mb-3">
          <label for="locationDropdown" class="form-label">Select Location:</label>
          <select id="locationDropdown" class="form-select"></select>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-light">
            <tr>
              <th>Select</th>
              <th>Name</th>
              <th>Army Number</th>
              <th>Rank</th>
              <th>Trade</th>
              <th>Coy</th>
            </tr>
            </thead>
            <tbody id="personnelTableBody"></tbody>
          </table>
        </div>
      </div>
      <p id="warningMessage" style="color: red; font-weight: bold;"></p>

      <div class="modal-footer">
        <button class="btn btn-primary" id="assignBtn">Assign Selected</button>
      </div>
    </div>
  </div>
</div>
<script>
  let selectedPersonnel = new Set();
  const dropdown = document.getElementById('locationDropdown');
  const actionSelect = document.getElementById('actionType');
  
  // -----------------------------------------------
  // ðŸ†• Change dropdown options based on Action Type
  // -----------------------------------------------
  actionSelect.addEventListener("change", async function () {
    const selectedAction = this.value;
  
    dropdown.innerHTML = ""; // reset dropdown
  
    if (selectedAction === "posting") {
        // ðŸ†• Show ONLY P1, P2, P3, P4
        const postingOptions = ["P1", "P2", "P3", "P4"];
        dropdown.innerHTML = postingOptions.map(p => `<option value="${p}">${p}</option>`).join('');
    
    } else if (selectedAction === "det") {
        // Load Locations from Database
        const res = await fetch('/get_locations');
        const locations = await res.json();
        dropdown.innerHTML = locations.map(l => `<option value="${l.det_id}">${l.det_name}</option>`).join('');
    }
  });
  
  // Load dropdown on modal open (det default)
  document.getElementById('personnelModal').addEventListener('shown.bs.modal', async () => {
    const res = await fetch('/get_locations');
    const locations = await res.json();
    dropdown.innerHTML = locations.map(l => `<option value="${l.det_id}">${l.det_name}</option>`).join('');
  });
  
  // Search button click
  document.getElementById('searchBtn').addEventListener('click', async () => {
    const query = document.getElementById('searchInput').value;
    const res = await fetch(`/search_personnel?query=${encodeURIComponent(query)}`);
    const personnel = await res.json();
    
    personnel.sort((a, b) => (selectedPersonnel.has(a.id) ? -1 : 1));
    
    const tbody = document.getElementById('personnelTableBody');
    tbody.innerHTML = "";
  
    personnel.forEach(person => {
      const row = tbody.insertRow();
      row.insertCell().innerHTML = `<input type="checkbox" class="personnel-checkbox" data-id="${person.army_number}" ${selectedPersonnel.has(person.army_number) ? "checked" : ""}>`;
      row.insertCell().textContent = person.name;
      row.insertCell().textContent = person.army_number;
      row.insertCell().textContent = person.rank;
      row.insertCell().textContent = person.trade;
      row.insertCell().textContent = person.company;
    });
  
    const warning = document.getElementById('warningMessage');
    const assignBtn = document.getElementById('assignBtn');
  
    const alreadyInDet = personnel.some(p => p.det_status == 1);
    const alreadyPosted = personnel.some(p => p.posting_status == 1);
    
    if (alreadyInDet) {
      warning.textContent = "âš ï¸ This personnel is already in DET.";
      assignBtn.disabled = true;
    } 
    else if (alreadyPosted) {
      warning.textContent = "âš ï¸ This personnel is already Posted.";
      assignBtn.disabled = true;
    } 
    else {
      warning.textContent = "";
      assignBtn.disabled = false;
    }
  });
  
  // Track checkbox selections
  document.addEventListener('change', e => {
    if (e.target.classList.contains('personnel-checkbox')) {
      const id = e.target.getAttribute('data-id');
      if (e.target.checked) selectedPersonnel.add(id);
      else selectedPersonnel.delete(id);
    }
  });
  
  // Assign button
  document.getElementById('assignBtn').addEventListener('click', async () => {
    const locationId = dropdown.value;
    const actionType = actionSelect.value;
  
    if (selectedPersonnel.size === 0) return alert("Select at least one person.");
    if (!actionType) return alert("Select an Action.");
    if (!locationId) return alert("Select a location.");
  
    const res = await fetch('/assign_personnel', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        army_number: Array.from(selectedPersonnel),
        det_id: locationId,
        action: actionType   // ðŸ†• Send whether it's det or posting
      })
    });
    
    const data = await res.json();
    alert(data.message || data.error);
    location.reload();
  });
  </script>
  
