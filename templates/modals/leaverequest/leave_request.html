

  <style>
    .leave-modal-wide {
      min-height: 40%;
    }
  </style>
</head>


<!-- Button to Open Leave Requests -->
<button id="leaveRequestsBtn" class="btn btn-primary">
  Open Leave Requests
</button>

<!-- Leave Requests Modal -->
<div class="modal fade" id="leaveRequestsModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable modal-fullscreen-sm-down">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Leave Requests</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item">
            <button class="nav-link active" id="pending-tab"
              data-bs-toggle="tab" data-bs-target="#pending">
              Pending
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" id="recommended-tab"
              data-bs-toggle="tab" data-bs-target="#recommended">
              Recommended
            </button>
          </li>
        </ul>

        <div class="tab-content">

          <!-- Pending Tab -->
          <div class="tab-pane fade show active" id="pending">

            <div id="leaveRequestsSpinner" class="text-center my-3">
              <div class="spinner-border text-primary"></div>
            </div>

            <table class="table table-striped d-none" id="leaveRequestsTable">
              <thead>
                <tr>
                  <th>Army Number</th>
                  <th>Leave Type</th>
                  <th>Days</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="leaveRequestsTableBody"></tbody>
            </table>

          </div>

          <!-- Recommended Tab -->
          <div class="tab-pane fade" id="recommended">

            <div id="recommendedSpinner" class="text-center my-3">
              <div class="spinner-border text-success"></div>
            </div>

            <table class="table table-striped d-none" id="recommendedTable">
              <thead>
                <tr>
                  <th>Army Number</th>
                  <th>Leave Type</th>
                  <th>Days</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="recommendedTableBody"></tbody>
            </table>

          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- View Leave Modal -->
<div class="modal fade" id="viewLeaveModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable leave-modal-wide">
    <div class="modal-content shadow-lg">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Leave Request Details</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div id="viewLeaveSpinner" class="text-center my-4">
          <div class="spinner-border text-primary"></div>
        </div>

        <div id="viewLeaveContent" class="d-none">
          <div class="row g-3">

            <div class="col-md-6">
              <label class="fw-bold">Army Number</label>
              <div class="form-control bg-light" id="v_army_number"></div>
            </div>

            <div class="col-md-6">
              <label class="fw-bold">Name</label>
              <div class="form-control bg-light" id="name"></div>
            </div>

            <div class="col-md-6">
              <label class="fw-bold">Leave Days</label>
              <div class="form-control bg-light" id="v_leave_days"></div>
            </div>

            <div class="col-md-6">
              <label class="fw-bold">Leave Type</label>
              <div class="form-control bg-light" id="v_leave_type"></div>
            </div>

            <div class="col-md-6">
              <label class="fw-bold">From Date</label>
              <div class="form-control bg-light" id="v_from_date"></div>
            </div>

            <div class="col-md-6">
              <label class="fw-bold">To Date</label>
              <div class="form-control bg-light" id="v_to_date"></div>
            </div>

            <div class="col-12">
              <label class="fw-bold">Reason</label>
              <div class="form-control bg-light" style="min-height:80px" id="v_reason"></div>
            </div>

            <div class="col-12">
              <label class="fw-bold">Status</label>
              <span class="badge fs-6" id="v_status"></span>
            </div>

          </div>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button id="recommend-button" class="btn btn-success">Recommend</button>
        <button id="reject-button" onclick="rejected(this)" class="btn btn-danger">Reject</button>
      </div>

    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* Reject */
function rejected(btn) {
  const leaveId = btn.dataset.unique_id;
  if (!leaveId) return alert("Leave ID missing");
  alert("Rejecting leave ID: " + leaveId);
}

/* View Leave */
async function viewLeaveRequest(id) {
  currentLeaveId = id; // ðŸ‘ˆ IMPORTANT

  const modal = new bootstrap.Modal(document.getElementById("viewLeaveModal"));
  modal.show();

  document.getElementById("viewLeaveSpinner").classList.remove("d-none");
  document.getElementById("viewLeaveContent").classList.add("d-none");

  const res = await fetch(`/apply_leave/get_leave_request/${id}`);
  const { data } = await res.json();

  document.getElementById("v_army_number").innerText = data.army_number;
  document.getElementById("name").innerText = data.name;
  document.getElementById("v_leave_days").innerText = data.leave_days;
  document.getElementById("v_leave_type").innerText = data.leave_type;
  document.getElementById("v_from_date").innerText = data.from_date;
  document.getElementById("v_to_date").innerText = data.to_date;
  document.getElementById("v_reason").innerText = data.leave_reason;

  const badge = document.getElementById("v_status");
  badge.innerText = data.request_status;
  badge.className = "badge fs-6 bg-warning";

  document.getElementById("reject-button").dataset.unique_id = id;

  document.getElementById("viewLeaveSpinner").classList.add("d-none");
  document.getElementById("viewLeaveContent").classList.remove("d-none");
}

/* RECOMMEND CLICK */
document.getElementById("recommend-button").addEventListener("click", async () => {
  if (!currentLeaveId) {
    alert("Leave ID missing");
    return;
  }

  if (!confirm("Are you sure you want to recommend this leave?")) return;

  try {
    const res = await fetch("/apply_leave/recommend_leave", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        leave_id: currentLeaveId
      })
    });

    const result = await res.json();

    if (!res.ok) {
      alert(result.message || "Failed to recommend leave");
      return;
    }

    alert("Leave recommended successfully");

    // Close modal
    bootstrap.Modal.getInstance(
      document.getElementById("viewLeaveModal")
    ).hide();

    // Reload tables
    loadLeaveRequests();
    loadRecommendedLeaves();

  } catch (err) {
    console.error(err);
    alert("Server error");
  }
});

/* Pending */
async function loadLeaveRequests() {
  const spinner = document.getElementById("leaveRequestsSpinner");
  const table = document.getElementById("leaveRequestsTable");
  const tbody = document.getElementById("leaveRequestsTableBody");

  spinner.classList.remove("d-none");
  table.classList.add("d-none");
  tbody.innerHTML = "";
  

  const res = await fetch("/apply_leave/get_leave_requests");
  const { data } = await res.json();
  
if (!data || data.length === 0) {
  tbody.innerHTML = `
    <tr>
      <td colspan="4" class="text-center text-muted">
        No leave requests found
      </td>
    </tr>
  `;
  spinner.style.display = 'none'
  table.classList.remove("d-none");
  return;
}

  
  data.forEach(row => {
    tbody.innerHTML += `
      <tr>
        <td>${row.army_number}</td>
        <td>${row.leave_type}</td>
        <td>${row.leave_days}</td>
        <td>
          <button class="btn btn-sm btn-primary"
            onclick="viewLeaveRequest(${row.id})">View</button>
        </td>
      </tr>`;
  });

  spinner.classList.add("d-none");
  table.classList.remove("d-none");
}

/* Recommended */
async function loadRecommendedLeaves() {
  const spinner = document.getElementById("recommendedSpinner");
  const table = document.getElementById("recommendedTable");
  const tbody = document.getElementById("recommendedTableBody");

  spinner.classList.remove("d-none");
  table.classList.add("d-none");
  tbody.innerHTML = "";

  const res = await fetch("/apply_leave/get_recommended_requests");
  const { data } = await res.json();

  data.forEach(row => {
    tbody.innerHTML += `
      <tr>
        <td>${row.army_number}</td>
        <td>${row.leave_type}</td>
        <td>${row.leave_days}</td>
        <td><span class="badge bg-success">Recommended</span></td>
      </tr>`;
  });

  spinner.classList.add("d-none");
  table.classList.remove("d-none");
}

/* Events */
document.getElementById("leaveRequestsBtn")
  .addEventListener("click", () => {
    new bootstrap.Modal(
      document.getElementById("leaveRequestsModal")
    ).show();
    loadLeaveRequests();
  });

document.getElementById("pending-tab")
  .addEventListener("shown.bs.tab", loadLeaveRequests);

document.getElementById("recommended-tab")
  .addEventListener("shown.bs.tab", loadRecommendedLeaves);
</script>


