<!-- Modal -->
<div class="modal fade" id="personnelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Assign Personnel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex mb-3">
          <input type="text" id="searchInput" class="form-control me-2" placeholder="Search by name or trade">
          <button class="btn btn-success" id="searchBtn">Search</button>
        </div>

        <div class="mb-3">
          <label for="locationDropdown" class="form-label">Select Location:</label>
          <select id="locationDropdown" class="form-select"></select>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-light">
            <tr>
              <th>Select</th>
              <th>Name</th>
              <th>Army Number</th>
              <th>Rank</th>
              <th>Trade</th>
              <th>Coy</th>
            </tr>
            </thead>
            <tbody id="personnelTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="assignBtn">Assign Selected</button>
      </div>
    </div>
  </div>
</div>
<script>
let selectedPersonnel = new Set();

// Load dropdown on modal open
document.getElementById('personnelModal').addEventListener('shown.bs.modal', async () => {
  const res = await fetch('/get_locations');
  const locations = await res.json();
  console.log("Locations", locations);
  const dropdown = document.getElementById('locationDropdown');
  dropdown.innerHTML = locations.map(l => `<option value="${l.det_id}">${l.det_name}</option>`).join('');
});

// Search button click
document.getElementById('searchBtn').addEventListener('click', async () => {
  const query = document.getElementById('searchInput').value;
  const res = await fetch(`/search_personnel?query=${encodeURIComponent(query)}`);
  const personnel = await res.json();
  
  // Keep checked people on top
  personnel.sort((a, b) => (selectedPersonnel.has(a.id) ? -1 : 1));
  
  const tbody = document.getElementById('personnelTableBody');
  console.log('Personal data', personnel);
  tbody.innerHTML = personnel.map(person => `
    <tr>
      <td><input type="checkbox" class="personnel-checkbox" data-id="${person.army_number}" ${selectedPersonnel.has(person.army_number) ? 'checked' : ''}></td>
      <td>${person.name}</td>
      <td>${person.army_number}</td>
      <td>${person.rank}</td>
      <td>${person.trade}</td>
      <td>${person.company}</td>
    </tr>
  `).join('');
});

// Track checkbox selections
document.addEventListener('change', e => {
  if (e.target.classList.contains('personnel-checkbox')) {
    const id = e.target.getAttribute('data-id');
    if (e.target.checked) selectedPersonnel.add(id);
    else selectedPersonnel.delete(id);
  }
});

// Assign button
document.getElementById('assignBtn').addEventListener('click', async () => {
  const locationId = document.getElementById('locationDropdown').value;
  if (selectedPersonnel.size === 0) return alert("Select at least one person.");
  if (!locationId) return alert("Select a location.");

  const res = await fetch('/assign_personnel', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      army_number: Array.from(selectedPersonnel),
      det_id: locationId
    })
  });
  
  const data = await res.json();
  alert(data.message || data.error);
});
</script>
