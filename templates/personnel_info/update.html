{% extends "personnel_info/base.html" %}

{% block extra_css %}
<style>
  :root {
    --primary-color: #2c5aa0;
    --secondary-color: #8a0a0a;
    --light-bg: #f8f9fa;
    --accent-color: #d4af37;
  }
  
  /* Increased width for the entire page */
  .container-fluid {
    max-width: 80%;
    padding: 0 20px;
  }
  
  .form-container {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    padding: 30px;
    margin: 20px auto;
    border: 1px solid #e1e5eb;
    max-width: 100%;
  }
  
  /* Black color for all input fields */
  .form-control,
  .form-select,
  .form-check-input {
    color: #000000 !important;
    border-color: rgba(88, 87, 87, 1) !important;
  }
  
  .form-control:focus,
  .form-select:focus {
    border-color: var(--primary-color) !important;
    box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25) !important;
    color: #000000 !important;
  }
  
  .header-section {
    background: linear-gradient(135deg, var(--primary-color), #1a3a7a);
    color: white;
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 30px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  
  .header-section::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: var(--accent-color);
  }
  
  .header-section h1 {
    font-weight: 700;
    margin-bottom: 10px;
    font-size: 2.2rem;
  }
  
  .header-section p {
    font-size: 1.1rem;
    opacity: 0.9;
  }
  
  .form-section {
    margin-bottom: 35px;
    padding: 25px;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    background-color: var(--light-bg);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }
  
  .form-section:hover {
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
  }
  
  .section-header {
    color: var(--primary-color);
    border-bottom: 2px solid var(--secondary-color);
    padding-bottom: 12px;
    margin-bottom: 25px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .section-header i {
    color: var(--secondary-color);
  }
  
  .required::after {
    content: " *";
    color: red;
  }

  .form-label {
    font-weight: 600;
    margin-bottom: 8px;
    color: #444;
  }
  
  .dynamic-table {
    margin-top: 15px;
  }
  
  .dynamic-table .btn-add-row {
    margin-top: 10px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 15px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .dynamic-table .btn-add-row:hover {
    background-color: #1a3a7a;
    transform: translateY(-2px);
  }
  
  .photo-upload-area {
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 25px;
    text-align: center;
    margin-bottom: 15px;
    background-color: #f9f9f9;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .photo-upload-area:hover {
    border-color: var(--primary-color);
    background-color: #f0f4ff;
  }
  
  .photo-preview {
    max-width: 150px;
    max-height: 150px;
    margin: 10px auto;
    display: none;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  
  .conditional-section {
    display: none;
    margin-top: 15px;
    padding: 20px;
    background-color: #fff;
    border-radius: 8px;
    border-left: 4px solid var(--secondary-color);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  }
  
  .btn-submit {
    background: linear-gradient(135deg, var(--secondary-color), #6a0505);
    color: white;
    padding: 12px 40px;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .btn-submit:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    background: linear-gradient(135deg, #9a0a0a, #6a0505);
  }
  
  .nav-tabs {
    border-bottom: 2px solid var(--primary-color);
    margin-bottom: 25px;
  }
  
  .nav-tabs .nav-link {
    color: var(--primary-color);
    font-weight: 600;
    border: none;
    padding: 12px 25px;
    border-radius: 8px 8px 0 0;
    margin-right: 5px;
    transition: all 0.3s ease;
  }
  
  .nav-tabs .nav-link:hover {
    background-color: rgba(44, 90, 160, 0.1);
  }
  
  .nav-tabs .nav-link.active {
    background-color: var(--primary-color);
    color: white;
    border: none;
  }
  
  .error-message {
    color: red;
    font-size: 0.875em;
    display: none;
    margin-top: 5px;
  }
  
  .form-control.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
  }
  
  .card-style {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 20px;
    transition: all 0.3s ease;
  }
  
  .card-style:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
  }

  .btn-navigation {
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 25px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-navigation:hover {
    background-color: #1a3a7a;
    transform: translateY(-2px);
  }
  
  .progress-container {
    margin-bottom: 30px;
  }
  
  .progress-bar {
    background-color: var(--primary-color);
  }
  
  .info-box {
    background: linear-gradient(135deg, #e3f2fd, #f0f4ff);
    border-left: 4px solid var(--primary-color);
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
  }
  
  .info-box i {
    color: var(--primary-color);
    margin-right: 10px;
  }
  
  .table th {
    background-color: var(--primary-color);
    color: white;
  }
  
  .footer-note {
    text-align: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
    color: #666;
    font-size: 0.9rem;
  }

  /* Validation styles */
  .is-valid {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
  }
  
  .form-check-input.is-valid {
    border-color: #198754 !important;
  }
  
  .form-select.is-valid {
    border-color: #198754 !important;
  }

  /* Ensure black text in all states */
  .form-control.is-valid,
  .form-control.is-invalid {
    color: #000000 !important;
  }

  .table input.form-control {
    color: #000000 !important;
    border-color: #000000 !important;
  }

  .table input.form-control.is-invalid {
    border-color: #dc3545 !important;
  }

  .table input.form-control.is-valid {
    border-color: #198754 !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-xxl-12">
      <div class="form-container">
        <div class="header-section">
          <h1>
            <i class="fas fa-user-edit"></i> Update Army Personnel Information
          </h1>
          <p>
            Search and update personnel records
          </p>
        </div>

        <!-- Search Section -->
        <div class="search-section">
          <h3><i class="fas fa-search"></i> Search Personnel</h3>
          <div class="row align-items-end">
            <div class="col-md-8 mb-3">
              <label for="searchArmyNumber" class="form-label required">Enter Army Number</label>
              <input
                type="text"
                class="form-control"
                id="searchArmyNumber"
                placeholder="Enter army number to search..."
                required
              />
              <div class="error-message" id="searchArmyNumber-error">
                Please enter a valid army number
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <button type="button" class="btn btn-search w-100" id="btnSearchPersonnel">
                <i class="fas fa-search me-2"></i> Search
              </button>
            </div>
          </div>
          <div class="loading-spinner" id="loadingSpinner">
            <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
            <p class="mt-2">Loading personnel data...</p>
          </div>
        </div>

        <!-- Form Container (Hidden initially) -->
        <div id="formContainer">
          <div class="info-box">
            <i class="fas fa-info-circle"></i> <strong>Update Mode:</strong> Modify the fields below and click "Update Personnel" to save changes.
          </div>

          <!-- Include the same form structure as index.html but with id="updateArmyForm" -->
          <form id="updateArmyForm">
            <!-- Copy the entire tab structure from index.html -->
            <!-- Personal Details, Courses, Medical, Family, Additional tabs -->
            <!-- For brevity, I'll show the key parts -->
            
            <input type="hidden" id="personnelId" />
            <input type="hidden" id="originalArmyNumber" />

            <ul class="nav nav-tabs mb-4" id="formTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal" type="button" role="tab">
                  <i class="fas fa-user"></i> Personal Details
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="courses-tab" data-bs-toggle="tab" data-bs-target="#courses" type="button" role="tab">
                  <i class="fas fa-graduation-cap"></i> Courses & Service
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="medical-tab" data-bs-toggle="tab" data-bs-target="#medical" type="button" role="tab">
                  <i class="fas fa-heartbeat"></i> Medical Details
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="family-tab" data-bs-toggle="tab" data-bs-target="#family" type="button" role="tab">
                  <i class="fas fa-users"></i> Family Details
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="additional-tab" data-bs-toggle="tab" data-bs-target="#additional" type="button" role="tab">
                  <i class="fas fa-info-circle"></i> Additional Info
                </button>
              </li>
            </ul>

            <div class="tab-content" id="formTabsContent">
              <!-- Copy all tab content from index.html -->
              <!-- Personal Details Tab -->
              <div class="tab-pane fade show active" id="personal" role="tabpanel">
                <div class="form-section">
                  <h3 class="section-header">
                    <i class="fas fa-id-card"></i> Personal Information
                  </h3>

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="name" class="form-label required">Name</label>
                      <input type="text" class="form-control" id="name" required />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="armyNumber" class="form-label required">Army Number</label>
                      <input type="text" class="form-control" id="armyNumber" required readonly style="background-color: #e9ecef;" />
                    </div>
                  </div>
                  
                  <!-- Copy all other fields from index.html -->
                </div>
              </div>

              <!-- Copy all other tabs -->
            </div>

            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-secondary" id="btnCancelUpdate">
                <i class="fas fa-times"></i> Cancel
              </button>
              <button type="submit" class="btn btn-submit">
                <i class="fas fa-save"></i> Update Personnel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Complete JavaScript for update.html
// Include this in the {% block extra_js %} section

document.addEventListener("DOMContentLoaded", function () {
  const searchInput = document.getElementById('searchArmyNumber');
  const btnSearch = document.getElementById('btnSearchPersonnel');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const formContainer = document.getElementById('formContainer');
  const updateForm = document.getElementById('updateArmyForm');
  const btnCancel = document.getElementById('btnCancelUpdate');

  // ========== SEARCH FUNCTIONALITY ==========
  btnSearch.addEventListener('click', searchPersonnel);
  searchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchPersonnel();
    }
  });

  async function searchPersonnel() {
    const armyNumber = searchInput.value.trim();
    
    if (!armyNumber) {
      alert('Please enter an army number');
      return;
    }

    loadingSpinner.style.display = 'block';
    formContainer.style.display = 'none';

    try {
      const response = await fetch(`/personnel_information/api/personnel/search/${armyNumber}`);
      const result = await response.json();

      loadingSpinner.style.display = 'none';

      if (response.ok && result.success) {
        populateForm(result.data);
        formContainer.style.display = 'block';
        document.getElementById('formContainer').scrollIntoView({ behavior: 'smooth' });
      } else {
        alert(result.message || 'Personnel not found');
      }
    } catch (error) {
      console.error('Search error:', error);
      alert('An error occurred while searching');
      loadingSpinner.style.display = 'none';
    }
  }

  // ========== FORM POPULATION ==========
  function populateForm(data) {
    const p = data.personnel; // Shorthand
    
    // Store hidden IDs
    document.getElementById('personnelId').value = p.id;
    document.getElementById('originalArmyNumber').value = p.army_number;

    // Basic Information
    setValue('name', p.name);
    setValue('armyNumber', p.army_number);
    setValue('rank', p.rank);
    setValue('trade', p.trade);
    setValue('dateOfEnrollment', p.date_of_enrollment);
    setValue('dateOfBirth', p.date_of_birth);
    setValue('dateOfTOS', p.date_of_tos);
    setValue('dateOfTORS', p.date_of_tors);
    setValue('bloodGroup', p.blood_group);
    setValue('religion', p.religion);
    setValue('company', p.company);
    
    // Radio buttons
    setRadioValue('foodPreference', p.food_preference);
    setRadioValue('drinker', p.drinker);
    setRadioValue('willingPromotions', p.willing_promotions);
    setRadioValue('clothingCard', p.clothing_card);
    setRadioValue('borderArea', p.border_area);
    setRadioValue('loan', p.loan);
    setRadioValue('detailedCourse', p.detailed_course);
    setRadioValue('medCat', p.med_cat);
    setRadioValue('priorStation', p.prior_station);
    setRadioValue('workedIT', p.worked_it);
    setRadioValue('vehicleAGIF', p.vehicle_agif);
    setRadioValue('disabilityChild', p.disability_child);
    setRadioValue('maritalDiscord', p.marital_discord);
    setRadioValue('bringFamily', p.bring_family);

    // Qualifications and Awards
    setValue('civQualifications', p.civ_qualifications);
    setValue('decorationAwards', p.decoration_awards);
    setValue('lackingQualifications', p.lacking_qualifications);
    
    // Card Details
    setValue('iCardNo', p.i_card_no);
    setValue('iCardDate', p.i_card_date);
    setValue('iCardIssuedBy', p.i_card_issued_by);
    setValue('bpetGrading', p.bpet_grading);
    setValue('pptGrading', p.ppt_grading);
    setValue('bpetDate', p.bpet_date);
    
    // Documents
    setValue('panCardNo', p.pan_card_no);
    setValue('panPartII', p.pan_part_ii);
    setValue('aadharCardNo', p.aadhar_card_no);
    setValue('aadharPartII', p.aadhar_part_ii);
    
    // Bank Account
    setValue('jointAccountNo', p.joint_account_no);
    setValue('jointAccountBank', p.joint_account_bank);
    setValue('jointAccountIFSC', p.joint_account_ifsc);
    
    // Address
    setValue('homeHouseNo', p.home_house_no);
    setValue('homeVillage', p.home_village);
    setValue('homePhone', p.home_phone);
    setValue('homeTO', p.home_to);
    setValue('homePO', p.home_po);
    setValue('homePS', p.home_ps);
    setValue('homeTeh', p.home_teh);
    setValue('homeNRS', p.home_nrs);
    setValue('homeNMH', p.home_nmh);
    setValue('homeDistrict', p.home_district);
    setValue('homeState', p.home_state);
    setValue('distanceFromIB', p.distance_from_ib);
    
    // Physical Details
    setValue('height', p.height);
    setValue('weight', p.weight);
    setValue('chest', p.chest);
    setValue('identificationMarks', p.identification_marks);
    
    // Service Details
    setValue('courtCases', p.court_cases);
    setValue('totalLeavesEncashed', p.total_leaves_encashed);
    setValue('participationActivities', p.participation_activities);
    setValue('presentFamilyLocation', p.present_family_location);
    setValue('priorStationDate', p.prior_station_date);
    setValue('workedUnitTenure', p.worked_unit_tenure);
    
    // Medical Details
    setValue('lastRecatBDDate', p.last_recat_bd_date);
    setValue('lastRecatBDAt', p.last_recat_bd_at);
    setValue('nextRecatDue', p.next_recat_due);
    setValue('medicalProblem', p.medical_problem);
    setValue('restrictions', p.restrictions);
    setValue('computerKnowledge', p.computer_knowledge);
    setValue('itLiterature', p.it_literature);
    
    // Next of Kin
    setValue('kinName', p.kin_name);
    setValue('kinRelation', p.kin_relation);
    setValue('kinMarriageDate', p.kin_marriage_date);
    setValue('kinAccountNo', p.kin_account_no);
    setValue('kinBank', p.kin_bank);
    setValue('kinIFSC', p.kin_ifsc);
    setValue('kinPartII', p.kin_part_ii);
    
    // Vehicle Details
    setValue('vehicleRegNo', p.vehicle_reg_no);
    setValue('vehicleModel', p.vehicle_model);
    setValue('vehiclePurchaseDate', p.vehicle_purchase_date);
    setValue('drivingLicenseNo', p.driving_license_no);
    setValue('licenseIssueDate', p.license_issue_date);
    setValue('licenseExpiryDate', p.license_expiry_date);
    
    // Additional Information
    setValue('counselling', p.counselling);
    setValue('folderPreparedOn', p.folder_prepared_on);
    setValue('folderCheckedBy', p.folder_checked_by);
    setValue('domesticIssues', p.domestic_issues);
    setValue('otherRequests', p.other_requests);
    setValue('familyMedicalIssues', p.family_medical_issues);
    setValue('qualityPoints', p.quality_points);
    setValue('strengths', p.strengths);
    setValue('weaknesses', p.weaknesses);

    // Populate dynamic tables
    populateCourses(data.courses);
    populateUnits(data.units);
    populateLoans(data.loans);
    populatePunishments(data.punishments);
    populateDetailedCourses(data.detailed_courses);
    populateLeaves(data.leaves);
    populateFamily(data.family);
    populateChildren(data.children);
    populateMobiles(data.mobiles);
    populateDiscordCases(data.discord_cases);

    // Trigger conditional sections
    triggerConditionalSections();
  }

  function setValue(id, value) {
    const element = document.getElementById(id);
    if (element) {
      element.value = value || '';
    }
  }

  function setRadioValue(name, value) {
    if (value) {
      const radio = document.querySelector(`input[name="${name}"][value="${value}"]`);
      if (radio) {
        radio.checked = true;
      }
    }
  }

  // ========== DYNAMIC TABLE POPULATION ==========
  function populateCourses(courses) {
    const tbody = document.querySelector('#coursesTable tbody');
    tbody.innerHTML = '';
    
    if (!courses || courses.length === 0) {
      addCourseRow();
      return;
    }

    courses.forEach((course, index) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" class="form-control form-control-sm course-input" name="course[]" value="${course.course || ''}"></td>
        <td><input type="date" class="form-control form-control-sm" name="courseFrom[]" value="${course.from_date || ''}"></td>
        <td><input type="date" class="form-control form-control-sm" name="courseTo[]" value="${course.to_date || ''}"></td>
        <td><input type="text" class="form-control form-control-sm course-input" name="courseInstitute[]" value="${course.institute || ''}"></td>
        <td><input type="text" class="form-control form-control-sm course-input" name="courseGrading[]" value="${course.grading || ''}"></td>
        <td><input type="text" class="form-control form-control-sm course-input" name="courseRemarks[]" value="${course.remarks || ''}"></td>
      `;
    });
  }

  function populateUnits(units) {
    const tbody = document.querySelector('#unitsTable tbody');
    tbody.innerHTML = '';
    
    if (!units || units.length === 0) {
      addUnitRow();
      return;
    }

    units.forEach((unit, index) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" class="form-control form-control-sm unit-input" name="unit[]" value="${unit.unit || ''}"></td>
        <td><input type="date" class="form-control form-control-sm" name="unitFrom[]" value="${unit.from_date || ''}"></td>
        <td><input type="date" class="form-control form-control-sm" name="unitTo[]" value="${unit.to_date || ''}"></td>
        <td><input type="text" class="form-control form-control-sm unit-input" name="unitDuty[]" value="${unit.duty_performed || ''}"></td>
      `;
    });
  }

  function populateLoans(loans) {
    const tbody = document.querySelector('#loansTable tbody');
    tbody.innerHTML = '';
    
    if (!loans || loans.length === 0) {
      addLoanRow();
      return;
    }

    loans.forEach((loan, index) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" class="form-control form-control-sm loan-input" name="loanType[]" value="${loan.loan_type || ''}"></td>
        <td><input type="text" class="form-control form-control-sm loan-input" name="loanAmount[]" value="${loan.total_amount || ''}"></td>
        <td><input type="text" class="form-control form-control-sm loan-input" name="loanBank[]" value="${loan.bank_details || ''}"></td>
        <td><input type="text" class="form-control form-control-sm loan-input" name="loanEMI[]" value="${loan.emi_per_month || ''}"></td>
        <td><input type="text" class="form-control form-control-sm loan-input" name="loanPending[]" value="${loan.pending || ''}"></td>
        <td><input type="text" class="form-control form-control-sm loan-input" name="loanRemarks[]" value="${loan.remarks || ''}"></td>
      `;
    });
  }

  function populatePunishments(punishments) {
    const tbody = document.querySelector('#punishmentTable tbody');
    tbody.innerHTML = '';
    
    if (!punishments || punishments.length === 0) {
      addPunishmentRow();
      return;
    }

    punishments.forEach((punishment, index) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="date" class="form-control form-control-sm" name="punishmentDate[]" value="${punishment.punishment_date || ''}"></td>
        <td><input type="text" class="form-control form-control-sm punishment-input" name="punishment[]" value="${punishment.punishment || ''}"></td>
        <td><input type="text" class="form-control form-control-sm punishment-input" name="punishmentAASec[]" value="${punishment.aa_sec || ''}"></td>
        <td><input type="text" class="form-control form-control-sm punishment-input" name="punishmentRemarks[]" value="${punishment.remarks || ''}"></td>
      `;
    });
  }

  function populateDetailedCourses(courses) {
    const tbody = document.querySelector('#detailedCoursesTable tbody');
    tbody.innerHTML = '';
    
    if (!courses || courses.length === 0) {
      addDetailedCourseRow();
      return;
    }

    courses.forEach((course, index) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" class="form-control form-control-sm detailed-course-input" name="detailedCourseName[]" value="${course.course_name || ''}"></td>
        <td><input type="date" class="form-control form-control-sm" name="detailedCourseFrom[]" value="${course.from_date || ''}"></td>
        <td><input type="date" class="form-control form-control-sm" name="detailedCourseTo[]" value="${course.to_date || ''}"></td>
        <td><input type="text" class="form-control form-control-sm detailed-course-input" name="detailedCourseRemarks[]" value="${course.remarks || ''}"></td>
      `;
    });
  }

  function populateLeaves(leaves) {
    const tbody = document.querySelector('#leaveTable tbody');
    tbody.innerHTML = '';
    
    if (!leaves || leaves.length === 0) {
      addLeaveRow();
      return;
    }

    leaves.forEach((leave, index) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" class="form-control form-control-sm leave-input" name="leaveYear[]" value="${leave.year || ''}"></td>
        <td><input type="number" class="form-control form-control-sm" name="leaveAL[]" value="${leave.al_days || ''}"></td>
        <td><input type="number" class="form-control form-control-sm" name="leaveCL[]" value="${leave.cl_days || ''}"></td>
        <td><input type="number" class="form-control form-control-sm" name="leaveAAL[]" value="${leave.aal_days || ''}"></td>
        <td><input type="number" class="form-control form-control-sm" name="leaveTotal[]" value="${leave.total_days || ''}"></td>
        <td><input type="text" class="form-control form-control-sm leave-input" name="leaveRemarks[]" value="${leave.remarks || ''}"></td>
      `;
    });
  }

  function populateFamily(family) {
    const tbody = document.querySelector('#familyTable tbody');
    tbody.innerHTML = '';
    
    if (!family || family.length === 0) {
      addFamilyRow();
      return;
    }

    family.forEach((member) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td><input type="text" class="form-control form-control-sm family-input" name="familyRelation[]" value="${member.relation || ''}"></td>
        <td><input type="text" class="form-control form-control-sm family-input" name="familyName[]" value="${member.name || ''}"></td>
        <td><input type="date" class="form-control form-control-sm" name="familyDOB[]" value="${member.date_of_birth || ''}"></td>
        <td><input type="text" class="form-control form-control-sm family-input" name="familyUID[]" value="${member.uid_no || ''}"></td>
        <td><input type="text" class="form-control form-control-sm family-input" name="familyPartII[]" value="${member.part_ii_order || ''}"></td>
      `;
    });
  }

  function populateChildren(children) {
    const tbody = document.querySelector('#childrenTable tbody');
    tbody.innerHTML = '';
    
    if (!children || children.length === 0) {
      addChildRow();
      return;
    }

    children.forEach((child, index) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" class="form-control form-control-sm children-input" name="childName[]" value="${child.name || ''}"></td>
        <td><input type="date" class="form-control form-control-sm" name="childDOB[]" value="${child.date_of_birth || ''}"></td>
        <td><input type="text" class="form-control form-control-sm children-input" name="childClass[]" value="${child.class || ''}"></td>
        <td><input type="text" class="form-control form-control-sm children-input" name="childPartII[]" value="${child.part_ii_order || ''}"></td>
        <td><input type="text" class="form-control form-control-sm children-input" name="childUID[]" value="${child.uid_no || ''}"></td>
      `;
    });
  }

  function populateMobiles(mobiles) {
    const tbody = document.querySelector('#mobileTable tbody');
    tbody.innerHTML = '';
    
    if (!mobiles || mobiles.length === 0) {
      addMobileRow();
      return;
    }

    mobiles.forEach((mobile, index) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" class="form-control form-control-sm mobile-input" name="mobileType[]" value="${mobile.type || ''}"></td>
        <td><input type="text" class="form-control form-control-sm mobile-input" name="mobileNumber[]" value="${mobile.number || ''}"></td>
        <td><input type="text" class="form-control form-control-sm mobile-input" name="mobileProvider[]" value="${mobile.service_provider || ''}"></td>
        <td><input type="text" class="form-control form-control-sm mobile-input" name="mobileRemarks[]" value="${mobile.remarks || ''}"></td>
      `;
    });
  }

  function populateDiscordCases(cases) {
    const tbody = document.querySelector('#discordTable tbody');
    tbody.innerHTML = '';
    
    if (!cases || cases.length === 0) {
      addDiscordRow();
      return;
    }

    cases.forEach((discordCase, index) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" class="form-control form-control-sm discord-input" name="discordCaseNo[]" value="${discordCase.case_no || ''}"></td>
        <td><input type="text" class="form-control form-control-sm discord-input" name="discordAmount[]" value="${discordCase.amount_to_pay || ''}"></td>
        <td><input type="text" class="form-control form-control-sm discord-input" name="discordSanction[]" value="${discordCase.sanction_letter_no || ''}"></td>
      `;
    });
  }

  function triggerConditionalSections() {
    // Trigger change events on all checked radio buttons to show/hide conditional sections
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
      radio.dispatchEvent(new Event('change'));
    });
  }

  // ========== ADD EMPTY ROW FUNCTIONS (same as in index.html) ==========
  function addCourseRow() {
    const tbody = document.querySelector('#coursesTable tbody');
    const rowCount = tbody.rows.length;
    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${rowCount + 1}</td>
      <td><input type="text" class="form-control form-control-sm course-input" name="course[]"></td>
      <td><input type="date" class="form-control form-control-sm" name="courseFrom[]"></td>
      <td><input type="date" class="form-control form-control-sm" name="courseTo[]"></td>
      <td><input type="text" class="form-control form-control-sm course-input" name="courseInstitute[]"></td>
      <td><input type="text" class="form-control form-control-sm course-input" name="courseGrading[]"></td>
      <td><input type="text" class="form-control form-control-sm course-input" name="courseRemarks[]"></td>
    `;
  }

  // Add similar functions for other tables...
  function addUnitRow() { /* ... */ }
  function addLoanRow() { /* ... */ }
  function addPunishmentRow() { /* ... */ }
  function addDetailedCourseRow() { /* ... */ }
  function addLeaveRow() { /* ... */ }
  function addFamilyRow() { /* ... */ }
  function addChildRow() { /* ... */ }
  function addMobileRow() { /* ... */ }
  function addDiscordRow() { /* ... */ }

  // ========== FORM SUBMISSION ==========
  updateForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!confirm('Are you sure you want to update this personnel record?')) {
      return;
    }

    const formData = collectFormData();
    const armyNumber = document.getElementById('originalArmyNumber').value;
    
    const submitBtn = updateForm.querySelector('.btn-submit');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    submitBtn.disabled = true;

    try {
      const response = await fetch(`/personnel_information/api/personnel/update/${armyNumber}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      const result = await response.json();
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;

      if (response.ok && result.success) {
        alert('Personnel updated successfully!');
        formContainer.style.display = 'none';
        searchInput.value = '';
        updateForm.reset();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        alert(result.message || 'Failed to update personnel');
      }
    } catch (error) {
      console.error('Update error:', error);
      alert('An error occurred while updating');
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });

  // Cancel button
  btnCancel.addEventListener('click', function() {
    if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
      formContainer.style.display = 'none';
      searchInput.value = '';
      updateForm.reset();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  // ========== COLLECT FORM DATA (same as index.html) ==========
  function collectFormData() {
    const data = {
      name: document.getElementById("name").value,
      armyNumber: document.getElementById("armyNumber").value,
      rank: document.getElementById("rank").value,
      trade: document.getElementById("trade").value,
      dateOfEnrollment: document.getElementById("dateOfEnrollment").value,
      dateOfBirth: document.getElementById("dateOfBirth").value,
      dateOfTOS: document.getElementById("dateOfTOS").value,
      dateOfTORS: document.getElementById("dateOfTORS").value,
      bloodGroup: document.getElementById("bloodGroup").value,
      religion: document.getElementById("religion").value,
      foodPreference: document.querySelector('input[name="foodPreference"]:checked')?.value || "",
      drinker: document.querySelector('input[name="drinker"]:checked')?.value || "",
      company: document.getElementById("company").value,
      // ... add all other fields from index.html

      courses: collectTableData("coursesTable", [
        "course", "courseFrom", "courseTo", "courseInstitute", "courseGrading", "courseRemarks"
      ]),
      units: collectTableData("unitsTable", ["unit", "unitFrom", "unitTo", "unitDuty"]),
      loans: collectTableData("loansTable", ["loanType", "loanAmount", "loanBank", "loanEMI", "loanPending", "loanRemarks"]),
      // ... add all other tables
    };

    return data;
  }

  function collectTableData(tableId, fieldNames) {
    const table = document.getElementById(tableId);
    const rows = table.querySelectorAll("tbody tr");
    const data = [];

    rows.forEach((row) => {
      const rowData = {};
      const inputs = row.querySelectorAll("input, select, textarea");

      inputs.forEach((input, index) => {
        if (fieldNames[index]) {
          rowData[fieldNames[index]] = input.value;
        }
      });
      
      if (Object.values(rowData).some((val) => val !== "")) {
        data.push(rowData);
      }
    });

    return data;
  }

  // ========== INCLUDE ALL DYNAMIC TABLE FUNCTIONS FROM INDEX.HTML ==========
  // Add event listeners for "Add Row" buttons
  document.getElementById("addCourseRow")?.addEventListener("click", () => addTableRow("coursesTable", "course-input"));
  document.getElementById("addUnitRow")?.addEventListener("click", () => addTableRow("unitsTable", "unit-input"));
  // ... add all others

  // Include all validation functions from index.html
  // setupRealTimeValidation(), validateField(), etc.
});
</script>
{% endblock %}