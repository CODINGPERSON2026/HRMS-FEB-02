{% extends "baseView.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Project Dashboard</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <script src="{{ url_for('static', filename='bootstrap/js/bootstrap.bundle.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='fontawesome-free-7.1.0-web/css/all.min.css') }}"/>
    
    <style>
        :root {
            --sidebar-width: 260px;
            --border: #e2e8f0;
            --bg-light: #f8fafc;
            --text: #2d3748;
            --text-light: #718096;
        }

        body {
            background: #f8fafc;
            margin: 0;
            min-height: 100vh;
        }

        .main-container {
            padding-left: var(--sidebar-width);
            transition: padding-left 0.3s ease;
        }

        .sidebar-collapsed .main-container {
            padding-left: 0;
        }

        .content-wrapper {
            padding: 20px;
        }

        /* Header */
        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        .dashboard-title {
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--text);
        }

        .dashboard-subtitle {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Stats Cards - Made smaller and using Bootstrap colors */
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 1rem; /* reduced padding */
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            height: 100%; /* equal height in row */
        }

        .stats-icon {
            width: 40px;   /* smaller icon */
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            margin-bottom: 0.5rem;
        }

        .stats-count {
            font-size: 1.5rem; /* smaller count */
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.2rem;
        }

        .stats-label {
            color: var(--text-light);
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Filter Buttons */
        .filter-btn {
            background: white;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.4rem 0.9rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .filter-btn:hover {
            background: #f1f5f9;
        }

        .filter-btn.active {
            background: #0d6efd; /* Bootstrap primary */
            color: white;
            border-color: #0d6efd;
        }

        /* Projects Grid (unchanged size-wise, only minor tweaks) */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .project-header {
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
        }

        .project-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cost-badge {
            background: #f1f5f9;
            color: var(--text);
            padding: 0.3rem 0.7rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid var(--border);
        }

        .stage-badge {
            background: #0d6efd; /* Bootstrap primary */
            color: white;
            padding: 0.3rem 0.7rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .project-body {
            padding: 1rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: var(--text-light);
            font-size: 0.9rem;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 0.5rem;
        }

        .progress-container {
            margin: 1rem 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .progress {
            height: 10px;
            background: #edf2f7;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .progress-bar {
            height: 100%;
            background: #0d6efd; /* Bootstrap primary */
            transition: width 0.8s ease;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-view {
            background: #fd7e14; /* Bootstrap warning/orange */
            color: white;
            padding: 0.6rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            flex: 1;
        }

        .btn-update {
            background: #0dcaf0; /* Bootstrap info */
            color: white;
            padding: 0.6rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            flex: 1;
        }

        .btn-advanced {
            background: #0d6efd; /* Bootstrap primary */
            color: white;
            border: none;
            padding: 0.7rem 1.4rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .floating-add-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            background: var(--bg-light);
            border-radius: 12px;
            border: 2px dashed #cbd5e0;
        }

        .empty-state i {
            font-size: 3.5rem;
            color: #cbd5e0;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="content-wrapper">
            <div class="container py-3">
                <!-- Dashboard Header -->
                <div class="dashboard-header">
                    <div class="d-flex justify-content-between align-items-start mb-4">
                        <div>
                            <h1 class="dashboard-title">Project Monitoring Dashboard</h1>
                            <p class="dashboard-subtitle">
                                <i class="fas fa-chart-line me-2"></i>
                                Real-time tracking and management of all projects
                            </p>
                        </div>
                        <button class="btn-advanced" data-bs-toggle="modal" data-bs-target="#addProjectModal">
                            <i class="fas fa-plus me-2"></i>Add New Project
                        </button>
                    </div>

                    <!-- Stats - Smaller cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3 col-6">
                            <div class="stats-card d-flex flex-column">
                                <div class="stats-icon bg-primary">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                <div class="stats-count">{{ projects|length }}</div>
                                <div class="stats-label mt-auto">Total Projects</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stats-card d-flex flex-column">
                                <div class="stats-icon bg-success">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stats-count">{{ projects|selectattr('current_stage', 'equalto', 'Completed')|list|length }}</div>
                                <div class="stats-label mt-auto">Completed</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stats-card d-flex flex-column">
                                <div class="stats-icon bg-warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stats-count">{{ projects|rejectattr('current_stage', 'equalto', 'Completed')|list|length }}</div>
                                <div class="stats-label mt-auto">In Progress</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stats-card d-flex flex-column">
                                <div class="stats-icon bg-info">
                                    <i class="fas fa-indian-rupee-sign"></i>
                                </div>
                                <div class="stats-count">₹{{ projects|sum(attribute='project_cost')|default(0)|int }}</div>
                                <div class="stats-label mt-auto">Total Budget</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="mb-3">
                        <h6 style="color: var(--text-light); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;">
                            Filter by Stage:
                        </h6>
                        <div class="d-flex flex-wrap gap-2" id="stageFilters">
                            <button class="filter-btn active" data-stage="all"><i class="fas fa-border-all me-2"></i>All Projects</button>
                            <button class="filter-btn" data-stage="AON"><i class="fas fa-hourglass-start me-2"></i>AON Stage</button>
                            <button class="filter-btn" data-stage="TOB"><i class="fas fa-tasks me-2"></i>TOB & TEC Stage</button>
                            <button class="filter-btn" data-stage="ATP"><i class="fas fa-rocket me-2"></i>ATP Stage</button>
                            <button class="filter-btn" data-stage="Completed"><i class="fas fa-check-circle me-2"></i>Completed</button>
                        </div>
                    </div>
                </div>

                <!-- Projects Grid -->
                <div class="projects-grid">
                    {% for p in projects %}
                        <div class="project-card" data-stage="{{ p.current_stage }}">
                            <div class="project-header">
                                <h5 class="project-title">
                                    <i class="fas fa-project-diagram"></i>
                                    {{ p.project_name }}
                                </h5>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="cost-badge">
                                        <i class="fas fa-indian-rupee-sign"></i> ₹{{ p.project_cost }}
                                    </span>
                                    <span class="stage-badge">{{ p.current_stage }}</span>
                                </div>
                            </div>
                            <div class="project-body">
                                <div class="mb-3">
                                    <div class="meta-item"><i class="fas fa-box"></i> {{ p.project_items or 'No items specified' }}</div>
                                    <div class="meta-item"><i class="fas fa-hashtag"></i> Qty: {{ p.quantity or 'N/A' }}</div>
                                </div>

                                {% if p.project_description %}
                                <div class="mb-3 p-3 bg-light rounded border" style="font-size: 0.85rem;">
                                    <strong><i class="fas fa-align-left me-1"></i>Description:</strong><br>
                                    {{ p.project_description|truncate(100) }}
                                </div>
                                {% endif %}

                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span>Progress</span>
                                        <span>{{ p.percent|int }}%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" style="width: 0%;" data-percent="{{ p.percent|int }}"></div>
                                    </div>
                                </div>

                                <div class="d-flex gap-2 mt-3">
                                    <button class="btn-view" onclick="openUpdateModal('{{ p.project_id|default(loop.index) }}', '{{ p.current_stage }}')">
                                        <i class="fas fa-edit me-2"></i>Update Stage
                                    </button>
                                    <button class="btn-update" onclick="viewProjectDetails('{{ p.project_id|default(loop.index) }}')">
                                        <i class="fas fa-eye me-2"></i>View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h4>No Projects Found</h4>
                            <p>Click "Add New Project" to get started</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Add Project Modal -->
            <div class="modal fade" id="addProjectModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Add New Project</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addProjectForm" class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Project Name *</label>
                                    <input class="form-control" name="project_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Current Stage *</label>
                                    <select class="form-select" name="current_stage" required>
                                        <option value="">Select Stage</option>
                                        <option value="AON">AON Stage</option>
                                        <option value="TOB">TOB & TEC Stage</option>
                                        <option value="ATP">ATP Stage</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Project Cost (₹) *</label>
                                    <input class="form-control" name="project_cost" type="number" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Items</label>
                                    <input class="form-control" name="project_items">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Quantity</label>
                                    <input class="form-control" name="quantity" type="number">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" name="project_description" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn-advanced" onclick="addProject()">Save Project</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Update Stage Modal -->
            <div class="modal fade" id="updateStageModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-white">
                            <h5 class="modal-title"><i class="fas fa-sync-alt me-2"></i>Update Project Stage</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="edit_project_id">
                            <label class="form-label">New Stage</label>
                            <select class="form-select" id="new_stage">
                                <option value="">Select New Stage</option>
                                <option value="AON">AON Stage</option>
                                <option value="TOB">TOB & TEC Stage</option>
                                <option value="ATP">ATP Stage</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-warning" onclick="updateStage()">Update Stage</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="floating-add-btn" data-bs-toggle="modal" data-bs-target="#addProjectModal">
        <i class="fas fa-plus"></i>
    </button>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".progress-bar[data-percent]").forEach(bar => {
                const pct = parseInt(bar.dataset.percent) || 0;
                setTimeout(() => {
                    bar.style.width = pct + "%";
                    bar.textContent = pct + "%";
                }, 200);
            });

            document.querySelectorAll("#stageFilters button").forEach(btn => {
                btn.addEventListener("click", function () {
                    document.querySelectorAll("#stageFilters button").forEach(b => b.classList.remove("active"));
                    this.classList.add("active");

                    const stage = this.dataset.stage;
                    document.querySelectorAll(".project-card").forEach(card => {
                        if (stage === "all" || card.dataset.stage === stage) {
                            card.style.display = "block";
                            card.style.opacity = "1";
                        } else {
                            card.style.opacity = "0";
                            setTimeout(() => card.style.display = "none", 300);
                        }
                    });
                });
            });
        });

        function addProject() {
            $.post("/add_project", $("#addProjectForm").serialize(), function (res) {
                if (res.status === "success") {
                    alert("Project added successfully!");
                    location.reload();
                } else {
                    alert("Error adding project");
                }
            });
        }

        function openUpdateModal(id, stage) {
            $("#edit_project_id").val(id);
            $("#new_stage").val(stage);
            new bootstrap.Modal(document.getElementById("updateStageModal")).show();
        }

        function updateStage() {
            const projectId = $("#edit_project_id").val();
            const newStage = $("#new_stage").val();
            if (!newStage) return alert("Please select a stage");

            $.post("/update_stage", { project_id: projectId, new_stage: newStage }, function(res) {
                if (res.status === "success") {
                    alert("Stage updated!");
                    location.reload();
                } else {
                    alert("Error updating stage");
                }
            });
        }

        function viewProjectDetails(id) {
            alert("View details for project ID: " + id);
        }
    </script>
</body>
</html>
{% endblock %}