{% extends "baseView.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Apply Leave</title>

    <!-- Bootstrap 5 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .content-wrapper {
            padding: 25px;
            background-color: #f4f6f9;
            min-height: 100vh;
        }
        .card {
            border-radius: 12px;
        }
        .table thead th {
            background-color: #0d6efd;
            color: white;
        }
        .search-box {
            max-width: 400px;
        }
    </style>
</head>

<body>

<div class="content-wrapper" style="padding-left: 16rem;">

    <!-- Title -->
    <div class="mb-4">
        <h3 class="fw-bold">Apply Leave</h3>
        <p class="text-muted">Search employee → Select employee → View leave balance → Apply leave</p>
    </div>

    <!-- Search Box -->
    <div class="card shadow-sm p-4 mb-4">
        <h5 class="mb-3">Search Employee</h5>
        <div class="input-group search-box">
            <input type="text" id="searchName" class="form-control" placeholder="Enter name">
            <button class="btn btn-primary" id="searchBtn">Search</button>
        </div>
    </div>

    <!-- Search Results -->
    <div id="resultsSection" class="card shadow-sm p-4 mb-4" style="display:none;">
        <h5 class="mb-3">Select Employee</h5>

        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Name</th>
                </tr>
            </thead>
            <tbody id="resultsTable"></tbody>
        </table>
    </div>

    <!-- Leave Details Section -->
    <div id="leaveDetailsDiv" class="card shadow-sm p-4" style="display:none;">
        <h5 class="mb-3">Leave Balance</h5>

        <table class="table table-bordered table-striped mb-4">
            <thead>
                <tr>
                    <th>Leave Type</th>
                    <th>Total</th>
                    <th>Taken</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody id="leaveTable"></tbody>
        </table>

        <!-- Apply Leave Form -->
        <h6 class="fw-bold mb-3">Apply for Leave</h6>

        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Leave Type</label>
                <select id="leaveType" class="form-select"></select>
            </div>

            <div class="col-md-4">
                <label class="form-label">Number of Days</label>
                <input type="number" id="days" class="form-control" placeholder="Enter days">
            </div>

            <div class="col-md-4 d-flex align-items-end">
                <button id="applyLeaveBtn" class="btn btn-success w-100">Apply Leave</button>
            </div>
        </div>
    </div>

</div> <!-- end content wrapper -->

<script>
let selectedPersonId = null;

// Search button click
$("#searchBtn").click(async function(){
    let name = $("#searchName").val().trim();
    console.log('Searched');
    if (name === "") {
        alert("Please enter a name to search.");
        return;
    }
    const res = await fetch(`/search_personnel?query=${encodeURIComponent(name)}`);
    const personnel = await res.json();
        console.log(personnel)
        personnel.forEach(function(row){
            $("#resultsTable").append(`
                <tr>
                    <td>
                        <input type="radio" name="selectPerson" value="${row.army_number}">
                    </td>
                    <td>${row.name}</td>
                </tr>
            `);
        });

});

// On selecting employee
$(document).on("change", "input[name='selectPerson']", function(){
    selectedPersonId = $(this).val();

    $.post("/get_leave_details", {person_id: selectedPersonId}, function(data){

        $("#leaveDetailsDiv").show();
        $("#leaveTable").empty();
        $("#leaveType").empty();

        data.forEach(function(row){
            $("#leaveTable").append(`
                <tr>
                    <td>${row.leave_type}</td>
                    <td>${row.total_leave}</td>
                    <td>${row.leave_taken}</td>
                    <td>${row.balance_leave}</td>
                </tr>
            `);

            $("#leaveType").append(`
                <option value="${row.leave_type}">${row.leave_type}</option>
            `);
        });
    });
});

// Apply Leave
$("#applyLeaveBtn").click(function(){
    let leave_type = $("#leaveType").val();
    let days = $("#days").val();

    if (!days || days <= 0) {
        alert("Enter valid number of days.");
        return;
    }

    $.post("/apply_leave_submit", {
        person_id: selectedPersonId,
        leave_type: leave_type,
        days: days
    }, function(response){
        alert(response.message);
        location.reload();
    });
});
</script>

<!-- Bootstrap JS -->


<script src="{{ url_for('static', filename='bootstrap/js/bootstrap.bundle.min.js') }}"></script>


</body>
</html>
{% endblock %}