{% extends "baseView.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <title>SmartHR Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CSS CDN -->
  <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
  
  {% include 'modals/alarm/alarm.html'%}
  <div id="fullscreenLoader">
    <div class="loader"></div>
  </div>
  
  
  <!-- Sidebar -->
  <div class="dashboard-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1>UNIT NAME</h1>
        <div class="d-flex align-items-center">
          <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="User" class="avatar me-2">
          <div>
            <span id="welcometext" class="fw-bold" >Welcome Back,{{role}} {{username}}</span><br>
          </div>
        </div>
      </div>
      <div class="top-bar-buttons d-flex align-items-center">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#personnelModal">Assign personal</button>
        <button id="leaveRequestsBtn" class="btn btn-warning ms-2">Leave Requests</button>
      </div>
    
    </div>

    <!-- Stats Row 1 -->
    <div class="row g-3 mb-4">
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">Parade State</small>
          <h3>120/154</h3>
          <span class="text-success">+2.1%</span>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">Total No of Project's</small>
          <h3>90/125</h3>
          <span class="text-danger">-2.1%</span>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">Dets</small>
          <h3 id="locationCount"></h3>
          <button id="viewDetailsBtn" class="view-details">View Details</button>
          
          {% include 'modals/detachmentModal/detachment.html'%}

        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">BOO's</small>
          <h3>25/28</h3>
          <span class="text-success">+11.2%</span>
        </div>
      </div>
        </div>

    <!-- Stats Row 2 -->
    <div class="row g-3 mb-4">
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">Lve Application</small>
          <h3>98</h3>
          <span class="text-success">+2.1%</span>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-sm-6">
 ;       <div class="card p-3 text-center">
          <small class="text-muted">New Arrival</small>
          <h3>45/48</h3>
          <span class="text-danger">-11.2%</span>
        </div>
      </div>
      
    </div>

    <!-- Status and Attendance -->
    <div class="row g-3 mb-4">
      <div class="col-lg-4">
        <div class="card p-3">
          <small class="text-muted">Man Power Status</small>
          <div>Total Employee: <b>154</b></div>
          <ul class="list-unstyled mt-3">
            <li><span class="status-dot dot-orange"></span> Auth (48%) - 112</li>
            <li><span class="status-dot dot-blue"></span> Hard Scale (20%) - 21</li>
            <li><span class="status-dot dot-green"></span> Present State (22%) - 12</li>
            <li><span class="status-dot dot-red"></span> On Lve (10%) - 4</li>
            <li><span class="status-dot dot-red"></span> In DET (10%) - 4</li>
            <li><span class="status-dot dot-red"></span> On TD (10%) - 4</li>
          </ul>
          <div class="mt-3"><b>Top Performer:</b> Daniel Esbella, IOS Developer (Performance 99%)</div>
        </div>
      </div>
      <!--  -->
      
    </div>
  </div>

  


{% include 'modals/personnelModal/personal_modal.html' %}
{% include 'modals/salesmodal/salesModal.html' %}
{% include 'modals/leaverequest/leave_request.html' %}


 
  




<script>
    // üî• Fullscreen loader hide after API fetch completes
function hideFullLoader() {
  const fullLoader = document.getElementById("fullscreenLoader");
  if (fullLoader) fullLoader.style.display = "none";
}

  // ------------------ Detachment Modal ------------------

  // ------------------ Dashboard Counts ------------------
async function get_dets() {
  try {
    const res = await fetch('/get_dets');
    if (!res.ok) throw new Error("Network error");
    const data = await res.json();
    console.log(data,"thisis count")
    document.getElementById('locationCount').innerText = data.count;

  } catch (err) {
    console.error("Error fetching location count:", err);
    document.getElementById('locationCount').innerText = 'fetching...';
  }

    hideFullLoader() // Hide loader after 0.5s
  }

document.addEventListener('DOMContentLoaded', get_dets);

  // ------------------ Leave Requests Modal ------------------
  document.getElementById("leaveRequestsBtn").addEventListener("click", async function() {
    const modal = new bootstrap.Modal(document.getElementById("leaveRequestsModal"));
    modal.show();
    await loadLeaveRequests();
  });

  async function loadLeaveRequests() {
    const spinner = document.getElementById("leaveRequestsSpinner");
    const table = document.getElementById("leaveRequestsTable");
    const tbody = document.getElementById("leaveRequestsTableBody");

    spinner.classList.remove("d-none");
    table.classList.add("d-none");
    tbody.innerHTML = "";

    try {
      const res = await fetch("/apply_leave/get_leave_requests");
      if (!res.ok) throw new Error("Network error");
      const result = await res.json();

      result.data.forEach(row => {
        tbody.innerHTML += `
          <tr>
            <td>${row.army_number}</td>
            <td>${row.leave_type}</td>
            <td>${row.leave_days}</td>
            <td>${row.request_status}</td>
            <td>${row.remarks}</td>
            <td>${row.created_at}</td>
            <td>${row.actions || row.request_status}</td>
          </tr>
        `;
      });

      spinner.classList.add("d-none");
      table.classList.remove("d-none");

    } catch (err) {
      console.error(err);
      spinner.innerHTML = `<p class="text-danger fw-bold mt-3">‚ùå Failed to load leave requests</p>`;
    }
  }

  // ------------------ Update Leave Status ------------------
  async function updateLeaveStatus(leaveId, status) {
    try {
      const res = await fetch('/apply_leave/update_leave_status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: leaveId, status: status })
      });
      const result = await res.json();
      if (result.status === 'success') {
        await loadLeaveRequests(); // Refresh table after update
      } else {
        alert("Failed to update leave status: " + result.message);
      }
    } catch (err) {
      console.error(err);
      alert("Error updating leave status.");
    }
  }
  </script>




  <!-- Add this inside your <script> tag -->



</body>
</html>
{% endblock %}