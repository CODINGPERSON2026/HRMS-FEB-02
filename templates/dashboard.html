{% extends "baseView.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SmartHR Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CSS CDN -->
  <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
  <div id="fullscreenLoader">
    <div class="loader"></div>
  </div>

  
  <!-- Sidebar -->
  <div class="dashboard-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1>UNIT NAME</h1>
        <div class="d-flex align-items-center">
          <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="User" class="avatar me-2">
          <div>
            <span id="welcometext" class="fw-bold" >Welcome Back,{{role}} {{username}}</span><br>
            <small>You have <span class="text-primary">21</span> Pending Approvals &amp; <span class="text-danger">14</span> Leave Requests</small>
          </div>
        </div>
      </div>
      <div class="top-bar-buttons d-flex align-items-center">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#personnelModal">Assign personal</button>
        <button class="btn btn-primary">Add Requests</button>
        <button class="btn btn-light ms-2">Export</button>
        <span class="ms-3 text-muted">2024 - 2025</span>
      </div>
    </div>

    <!-- Stats Row 1 -->
    <div class="row g-3 mb-4">
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">Parade State</small>
          <h3>120/154</h3>
          <span class="text-success">+2.1%</span>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">Total No of Project's</small>
          <h3>90/125</h3>
          <span class="text-danger">-2.1%</span>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">Dets</small>
          <h3 id="locationCount"></h3>
          <button id="viewDetailsBtn" class="view-details">View Details</button>


        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">BOO's</small>
          <h3>25/28</h3>
          <span class="text-success">+11.2%</span>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#salesModal">CSD Earnings</button>
          <h3>$21445</h3>
          <span class="text-success">+2.1%</span>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">Profit This Week</small>
          <h3>$5,544</h3>
          <span class="text-success">+2.2%</span>
        </div>
      </div>
    </div>

    <!-- Stats Row 2 -->
    <div class="row g-3 mb-4">
      <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card p-3 text-center">
          <small class="text-muted">Lve Application</small>
          <h3>98</h3>
          <span class="text-success">+2.1%</span>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-sm-6">
 ;       <div class="card p-3 text-center">
          <small class="text-muted">New Arrival</small>
          <h3>45/48</h3>
          <span class="text-danger">-11.2%</span>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card p-3">
          <small class="text-muted">Company Str</small>
          <div>
            <div>HQ Coy<div class="department-bar bar-uiux w-75 mb-2"></div></div>
            <div>1 Coy <div class="department-bar bar-dev w-100 mb-2"></div></div>
            <div>2 Coy <div class="department-bar bar-mgmt w-50 mb-2"></div></div>
            <div>3 Coy <div class="department-bar bar-hr w-25 mb-2"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status and Attendance -->
    <div class="row g-3 mb-4">
      <div class="col-lg-4">
        <div class="card p-3">
          <small class="text-muted">Man Power Status</small>
          <div>Total Employee: <b>154</b></div>
          <ul class="list-unstyled mt-3">
            <li><span class="status-dot dot-orange"></span> Auth (48%) - 112</li>
            <li><span class="status-dot dot-blue"></span> Hard Scale (20%) - 21</li>
            <li><span class="status-dot dot-green"></span> Present State (22%) - 12</li>
            <li><span class="status-dot dot-red"></span> On Lve (10%) - 4</li>
            <li><span class="status-dot dot-red"></span> In DET (10%) - 4</li>
            <li><span class="status-dot dot-red"></span> On TD (10%) - 4</li>
          </ul>
          <div class="mt-3"><b>Top Performer:</b> Daniel Esbella, IOS Developer (Performance 99%)</div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card p-3 text-center">
          <small class="text-muted">Attendance Overview</small>
          <!-- Replace with chart as needed -->
          <h4>Total Attendance: 120</h4>
          <ul class="list-unstyled mt-2">
            <li>Present: 59%</li>
            <li>Late: 21%</li>
            <li>Permission: 15%</li>
            <li>Absent: 5%</li>
          </ul>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card p-3">
          <small class="text-muted">Best Firers</small>
          <ul class="list-unstyled">
            <li class="d-flex align-items-center my-2">
              <img src="https://randomuser.me/api/portraits/women/2.jpg" class="avatar me-2">
              <span>Daniel Esbella<br><small>UI/UX Designer</small></span>
              <span class="badge bg-success ms-auto">09:15</span>
            </li>
            <li class="d-flex align-items-center my-2">
              <img src="https://randomuser.me/api/portraits/men/3.jpg" class="avatar me-2">
              <span>Doglas Martini<br><small>Project Manager</small></span>
              <span class="badge bg-success ms-auto">09:30</span>
            </li>
            <li class="d-flex align-items-center my-2">
              <img src="https://randomuser.me/api/portraits/men/4.jpg" class="avatar me-2">
              <span>Brian Villalobos<br><small>PHP Developer</small></span>
              <span class="badge bg-success ms-auto">09:33</span>
            </li>
            <li class="d-flex align-items-center my-2">
              <img src="https://randomuser.me/api/portraits/men/5.jpg" class="avatar me-2">
              <span>Anthony Lews<br><small>Marketing Head</small></span>
              <span class="badge bg-danger ms-auto">10:33</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- DET PERSONNEL MODAL -->
<!-- DET PERSONNEL MODAL -->
<div class="modal fade" id="detModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Personnel in DET</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- Spinner (visible while fetching) -->
        <div id="detSpinner" class="text-center my-4">
          <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
          <p class="mt-2">Fetching data...</p>
        </div>

        <!-- Table (hidden until fetch is complete) -->
        <table class="table table-striped d-none" id="detTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Army Number</th>
              <th>Rank</th>
            </tr>
          </thead>
          <tbody id="detTableBody"></tbody>
        </table>

      </div>
    </div>
  </div>
</div>



{% include 'personal_modal.html' %}
{% include 'salesModal.html' %}
 
  <script>
  
    // üî• Fullscreen loader hide after API fetch completes
function hideFullLoader() {
  const fullLoader = document.getElementById("fullscreenLoader");
  if (fullLoader) fullLoader.style.display = "none";
}

document.getElementById("viewDetailsBtn").addEventListener("click", function () {
  const detModal = new bootstrap.Modal(document.getElementById('detModal'));
  detModal.show();
  load_det_personnel();
});

async function load_det_personnel() {
  let spinner = document.getElementById("detSpinner");
  let table = document.getElementById("detTable");
  let tbody = document.getElementById("detTableBody");

  spinner.classList.remove("d-none");
  table.classList.add("d-none");
  tbody.innerHTML = "";

  try {
    const response = await fetch("/stats/get_detachment_details");
    const result = await response.json();

    if (result.status !== "success") throw new Error("Fetch failed");

    result.data.forEach(row => {
      tbody.innerHTML += `
        <tr>
          <td>${row.name}</td>
          <td>${row.army_number}</td>
          <td>${row.rank}</td>
        </tr>
      `;
    });

    spinner.classList.add("d-none");
    table.classList.remove("d-none");

  } catch (err) {
    console.error(err);
    spinner.innerHTML = `<p class="text-danger fw-bold mt-3">‚ùå Failed to load data</p>`;
  }
}

async function get_dets() {
  try {
    const res = await fetch('/get_dets');
    if (!res.ok) throw new Error("Network error");
    const data = await res.json();
    document.getElementById('locationCount').innerText = data.count;

  } catch (err) {
    console.error("Error fetching location count:", err);
    document.getElementById('locationCount').innerText = 'Waiting...';
  }

  // üëá Hide fullscreen loader only after dashboard data loaded
setTimeout(function(){
  hideFullLoader();

},3000)}

// Load dashboard API on page ready
document.addEventListener('DOMContentLoaded', get_dets);

      

  </script>
  <!-- Main Dashboard Content -->

  <!-- Bootstrap 5 JS Bundle CDN -->
</body>
</html>
{% endblock %}