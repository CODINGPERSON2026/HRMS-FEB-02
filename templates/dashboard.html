{% extends "base.html" %}
{% block title %}Dashboard - Army Personnel System{% endblock %}
{% block extra_css %}
<style>
  @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

  * {
    font-family:'Times New Roman', Times, serif;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    /* Light Theme */
    --bg-primary: #f8f9fa;
    --bg-secondary: #ffffff;
    --bg-accent: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --text-primary: #1a202c;
    --text-secondary: #718096;
    --border-color: #e2e8f0;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
    --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
    --card-bg: #ffffff;
    --accent-color: #667eea;
    --success-color: #48bb78;
    --warning-color: #ed8936;
    --danger-color: #f56565;
  }

  [data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --border-color: #334155;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
    --card-bg: #1e293b;
  }

  body {
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .dashboard-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  /* Header Section */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1.5rem 2rem;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
  }

  .header-left h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  .header-left p {
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  .header-right {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  /* Theme Toggle */
  .theme-toggle {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .theme-toggle i {
    font-size: 1.2rem;
    color: var(--accent-color);
  }

  .refresh-btn {
    padding: 0.75rem 1.5rem;
    background: var(--bg-accent);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--bg-accent);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: var(--bg-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .stat-icon i {
    font-size: 1.5rem;
    color: white;
  }

  .stat-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-weight: 500;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--text-primary);
    line-height: 1;
  }

  /* Charts Grid */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .chart-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
  }

  .col-span-12 { grid-column: span 12; }
  .col-span-8 { grid-column: span 8; }
  .col-span-6 { grid-column: span 6; }
  .col-span-4 { grid-column: span 4; }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .chart-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .chart-title i {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: var(--bg-accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
  }

  .chart-badge {
    padding: 0.4rem 0.9rem;
    background: rgba(102, 126, 234, 0.1);
    color: var(--accent-color);
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .chart-container {
    position: relative;
    height: 350px;
    width: 100%;
  }

  .chart-container-small {
    position: relative;
    height: 300px;
    width: 100%;
  }

  /* Recent Personnel Table */
  .recent-table {
    width: 100%;
    border-collapse: collapse;
  }

  .recent-table th {
    text-align: left;
    padding: 0.75rem;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .recent-table td {
    padding: 1rem 0.75rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
    font-size: 0.95rem;
  }

  .recent-table tr:hover {
    background: var(--bg-primary);
  }

  .rank-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: rgba(102, 126, 234, 0.1);
    color: var(--accent-color);
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  /* Actions Section */
  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    color: var(--text-primary);
    text-decoration: none;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .col-span-8, .col-span-6, .col-span-4 {
      grid-column: span 12;
    }
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }

    .header-right {
      width: 100%;
      justify-content: space-between;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>15 CESR</h1>
      <p>Real-time personnel analytics and insights</p>
    </div>
    <div class="header-right">
      <div class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon" id="theme-icon"></i>
      </div>
      <button class="refresh-btn" onclick="refreshData()">
        <i class="fas fa-sync-alt"></i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-label">Total Personnel</div>
      <div class="stat-value">{{ stats.total_personnel }}</div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <div class="stat-label">Total Courses</div>
      <div class="stat-value">{{ stats.total_courses }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-shield-alt"></i>
      </div>
      <div class="stat-label">Det Duty</div>
      <div class="stat-value">0</div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-medkit"></i>
      </div>
      <div class="stat-label">Medical Cases</div>
      <div class="stat-value">{{ stats.medical_cases }}</div>
      <div><a href="/personnel">More details</a></div>
    </div>
  </div>

  <!-- Charts Grid -->
  <div class="charts-grid">
    <!-- Age Distribution Donut Chart -->
    <div class="chart-card col-span-6">
      <div class="chart-header">
        <h3 class="chart-title">
          <i class="fas fa-chart-pie"></i>
          Age Distribution
        </h3>
        <span class="chart-badge">Live Data</span>
      </div>
      <div class="chart-container">
        <canvas id="ageDonutChart"></canvas>
      </div>
    </div>

    <!-- Rank Distribution Bar Chart -->
    <div class="chart-card col-span-6">
      <div class="chart-header">
        <h3 class="chart-title">
          <i class="fas fa-chart-bar"></i>
          Rank Distribution
        </h3>
        <span class="chart-badge">Updated</span>
      </div>
      <div class="chart-container">
        <canvas id="rankBarChart"></canvas>
      </div>
    </div>

    <!-- Recent Personnel -->
    <div class="chart-card col-span-8">
      <div class="chart-header">
        <h3 class="chart-title">
          <i class="fas fa-clock"></i>
          Recent Personnel
        </h3>
      </div>
      <div style="overflow-x: auto;">
        <table class="recent-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Army Number</th>
              <th>Rank</th>
              <th>Enrollment Date</th>
            </tr>
          </thead>
          <tbody>
            {% for person in recent_personnel %}
            <tr>
              <td>{{ person.name }}</td>
              <td>{{ person.army_number }}</td>
              <td><span class="rank-badge">{{ person.rank }}</span></td>
              <td>{{ person.date_of_enrollment.strftime('%d %b %Y') if person.date_of_enrollment else 'N/A' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="chart-card col-span-4">
      <div class="chart-header">
        <h3 class="chart-title">
          <i class="fas fa-bolt"></i>
          Quick Actions
        </h3>
      </div>
      <div class="actions-grid">
        <a href="/add-personnel" class="action-btn">
          <i class="fas fa-user-plus"></i>
          Add Personnel
        </a>
        <button class="action-btn" onclick="exportReport()">
          <i class="fas fa-file-export"></i>
          Export Report
        </button>
        <button class="action-btn" onclick="searchRecords()">
          <i class="fas fa-search"></i>
          Search
        </button>
        <button class="action-btn" onclick="openSettings()">
          <i class="fas fa-cog"></i>
          Settings
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Theme Management
  function toggleTheme() {
    const html = document.documentElement;
    const icon = document.getElementById('theme-icon');
    const currentTheme = html.getAttribute('data-theme');
    
    if (currentTheme === 'dark') {
      html.removeAttribute('data-theme');
      icon.className = 'fas fa-moon';
      localStorage.setItem('theme', 'light');
    } else {
      html.setAttribute('data-theme', 'dark');
      icon.className = 'fas fa-sun';
      localStorage.setItem('theme', 'dark');
    }
    
    // Reinitialize charts with new theme
    initializeCharts();
  }

  // Load saved theme
  document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = localStorage.getItem('theme');
    const icon = document.getElementById('theme-icon');
    
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      icon.className = 'fas fa-sun';
    }

    // Initialize Charts
    initializeCharts();
  });

  function refreshData() {
    location.reload();
  }

  function exportReport() {
    alert('Export functionality to be implemented');
  }

  function searchRecords() {
    alert('Search functionality to be implemented');
  }

  function openSettings() {
    alert('Settings functionality to be implemented');
  }

  let ageChart, rankChart;

  function initializeCharts() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#f1f5f9' : '#1a202c';
    const gridColor = isDark ? '#334155' : '#e2e8f0';

    // Prepare age distribution data from backend
    const ageLabels = {{ age_distribution | map(attribute='range') | list | tojson }};
    const ageData = {{ age_distribution | map(attribute='count') | list | tojson }};

    // Prepare rank distribution data from backend
    const rankLabels = {{ rank_distribution | map(attribute='rank') | list | tojson }};
    const rankData = {{ rank_distribution | map(attribute='count') | list | tojson }};

    // Destroy existing charts if they exist
    if (ageChart) ageChart.destroy();
    if (rankChart) rankChart.destroy();

    // Age Distribution Donut Chart
    const ageCtx = document.getElementById('ageDonutChart').getContext('2d');
    ageChart = new Chart(ageCtx, {
      type: 'doughnut',
      data: {
        labels: ageLabels,
        datasets: [{
          data: ageData,
          backgroundColor: [
          'rgba(10, 173, 249, 0.9)',
          'rgba(118, 75, 162, 0.9)',
          'rgba(240, 147, 251, 0.9)',
          'rgba(13, 46, 74, 0.9)',
          'rgba(67, 233, 123, 0.9)',
          'rgba(255, 193, 7, 0.9)',
          'rgba(252, 4, 4, 0.9)'
          ],
          borderWidth: 0,
          hoverOffset: 15
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              color: textColor,
              padding: 15,
              font: { size: 12 }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(26, 31, 58, 0.95)',
            padding: 12,
            titleColor: '#fff',
            bodyColor: '#fff',
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return label + ': ' + value + ' (' + percentage + '%)';
              }
            }
          }
        },
        cutout: '65%'
      }
    });

    // Rank Distribution Bar Chart
    const rankCtx = document.getElementById('rankBarChart').getContext('2d');
    
    const barColors = rankData.map((_, index) => {
      const colors = [
        'rgba(102, 126, 234, 0.8)',
        'rgba(118, 75, 162, 0.8)',
        'rgba(240, 147, 251, 0.8)',
        'rgba(79, 172, 254, 0.8)',
        'rgba(67, 233, 123, 0.8)',
        'rgba(255, 193, 7, 0.8)',
        'rgba(233, 30, 99, 0.8)',
        'rgba(156, 39, 176, 0.8)',
        'rgba(63, 81, 181, 0.8)',
        'rgba(0, 150, 136, 0.8)'
      ];
      return colors[index % colors.length];
    });
    
    const borderColors = rankData.map((_, index) => {
      const colors = [
        'rgba(102, 126, 234, 1)',
        'rgba(118, 75, 162, 1)',
        'rgba(240, 147, 251, 1)',
        'rgba(79, 172, 254, 1)',
        'rgba(67, 233, 123, 1)',
        'rgba(255, 193, 7, 1)',
        'rgba(233, 30, 99, 1)',
        'rgba(156, 39, 176, 1)',
        'rgba(63, 81, 181, 1)',
        'rgba(0, 150, 136, 1)'
      ];
      return colors[index % colors.length];
    });
    
    rankChart = new Chart(rankCtx, {
      type: 'bar',
      data: {
        labels: rankLabels,
        datasets: [{
          label: 'Personnel Count',
          data: rankData,
          backgroundColor: barColors,
          borderColor: borderColors,
          borderWidth: 2,
          borderRadius: 8,
          barPercentage: 0.7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(26, 31, 58, 0.95)',
            padding: 12,
            titleColor: '#fff',
            bodyColor: '#fff',
            callbacks: {
              label: function(context) {
                return 'Personnel: ' + context.parsed.y;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { 
              color: gridColor,
              drawBorder: false
            },
            ticks: { 
              color: textColor, 
              font: { size: 11 },
              stepSize: 50
            }
          },
          x: {
            grid: { display: false },
            ticks: { 
              color: textColor, 
              font: { size: 11 },
              maxRotation: 45,
              minRotation: 45
            }
          }
        }
      }
    });
  }
</script>
{% endblock %}